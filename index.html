<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Acoustic Analysis ‚Äî Normalization / Main</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --grid:#e9e9e9;
    --axes:#222;
    --text:#111;
    --blue:#2f6fed;
    --green:#1aab55;
    --green-dark:#0f6e35;
    --warn:#b15d00;
    --ok:#0a7a2e;
    --error:#b00020;
    --signal-start:#ff6b00;
    --signal-end:#ff0066;
  }
  body{font-family:Arial, sans-serif; margin:0; background:#fff; color:#111;}
  header{position:relative; padding:10px 12px; border-bottom:1px solid #ddd; background:#fafafa}
  h1{font-size:18px; margin:4px 0;}
  main{padding:8px 0 18px;}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin:8px 12px;}
  .button{padding:8px 14px; border-radius:8px; border:1px solid #ccc; cursor:pointer; background:#f5f5f5}
  .button.primary{background:#2f6fed; border-color:#2f6fed; color:#fff}
  .button.alt{background:#fbe9e7; border-color:#f5ccbd; color:#5d2a00}
  .button:disabled{opacity:0.5; cursor:not-allowed}
  #modeBadge{margin-left:auto; font-size:12px; padding:4px 8px; border-radius:999px; background:#eef; color:#223;}
  body[data-mode="normalization"] #modeBadge{background:#fff6d6; color:#6b4e00;}
  body[data-mode="main"] #modeBadge{background:#e6ffe7; color:#0a5c10;}
  .card{border:1px solid #ddd; border-radius:10px; padding:10px 12px; background:#fff; margin:8px 12px;}
  .status{margin:8px 12px; font-size:14px;}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.error{color:var(--error)}
  canvas{border:1px solid #ddd; border-radius:6px; margin:8px 12px;}
  .hint{font-size:12px; color:#555; margin:0 12px 12px;}
  #langBox{position:absolute; right:12px; top:10px;}
  #langSelect{padding:6px 10px; border-radius:6px; border:1px solid #ccc;}
  .signal-info{margin:8px 12px; padding:8px; background:#f9f9f9; border-radius:6px; font-family:monospace; font-size:13px;}
</style>
</head>
<body>
<header>
  <h1 id="titleText">–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ‚Äî –≠—Ç–∞–ø 1: ¬´–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª ‚Üí –≠—Ç–∞–ø 2: ¬´–û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑¬ª</h1>
  <div id="langBox">
    <select id="langSelect">
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="en">English</option>
      <option value="he">◊¢◊ë◊®◊ô◊™</option>
    </select>
  </div>
</header>

<main>
  <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
  <div class="toolbar" id="normToolbar">
    <button id="btnStartNorm" class="button">–ù–∞—á–∞—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <button id="btnFinishNorm" class="button primary">–ó–∞–∫–æ–Ω—á–∏—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <span id="modeBadge">–†–µ–∂–∏–º: ‚Äî</span>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—å—é -->
  <div class="toolbar">
    <button id="btnRequestMic" class="button alt">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</button>
    <button id="btnStart" class="button">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <button id="btnStop" class="button">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    <button id="btnReset" class="button">–°–±—Ä–æ—Å</button>
  </div>

  <div class="status" id="status">–ì–æ—Ç–æ–≤.</div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ -->
  <canvas id="mainGraph" width="980" height="340"></canvas>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏–≥–Ω–∞–ª–µ -->
  <div class="signal-info" id="signalInfo"></div>

  <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ -->
  <section id="historySection" class="card">
    <h3 style="margin:0 0 6px 0;">–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞</h3>
    <canvas id="historyGraph" width="980" height="240"></canvas>
    <div class="hint">–í —Ä–µ–∂–∏–º–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã —ç–Ω–µ—Ä–≥–∏–∏ (–í—Ç¬∑—Å/–º¬≤). –í –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äî –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã (–±–µ–∑—Ä–∞–∑–º–µ—Ä–Ω—ã–µ, –º–æ–≥—É—Ç –±—ã—Ç—å &gt;1 –∏–ª–∏ &lt;1).</div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:4px;">
      <button id="btnResetLast" class="button">–°–±—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ</button>
    </div>
  </section>
</main>

<script>
/* ===== I18N: RU / EN / HE ===== */
const LANG_KEY='ui_lang_v1';
function currLang(){ return localStorage.getItem(LANG_KEY)||'ru'; }
const translations={
  ru:{title:"–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ‚Äî –≠—Ç–∞–ø 1: ¬´–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª ‚Üí –≠—Ç–∞–ø 2: ¬´–û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑¬ª",startNorm:"–ù–∞—á–∞—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ",finishNorm:"–ó–∞–∫–æ–Ω—á–∏—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ",requestMic:"–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É",startRec:"–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å",stopRec:"–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",reset:"–°–±—Ä–æ—Å",resetLast:"–°–±—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ",historyTitle:"–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞",historyHint:"–í —Ä–µ–∂–∏–º–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã —ç–Ω–µ—Ä–≥–∏–∏ (–í—Ç¬∑—Å/–º¬≤). –í –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äî –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã (–±–µ–∑—Ä–∞–∑–º–µ—Ä–Ω—ã–µ, –º–æ–≥—É—Ç –±—ã—Ç—å >1 –∏–ª–∏ <1).",ready:"–ì–æ—Ç–æ–≤.",modeBadgeNorm:"–†–µ–∂–∏–º: –ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ",modeBadgeMain:"–†–µ–∂–∏–º: –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑",yLeft:"–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (—É—Å–ª. –µ–¥.)",yRightNorm:"–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è (–æ—Ç–Ω.)",yRightRaw:"–≠–Ω–µ—Ä–≥–∏—è (–í—Ç¬∑—Å/–º¬≤ ‚Äî —É—Å–ª.)",histYNorm:"–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Å–∏–º–ø—Ç–æ—Ç–∞ (–æ—Ç–Ω.)",histYAbs:"–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è (–í—Ç¬∑—Å/–º¬≤)",histX:"‚Ññ —Å–µ–∞–Ω—Å–∞ / –≤—Ä–µ–º—è",statusReady:"–ì–æ—Ç–æ–≤.",statusMicOk:"‚úÖ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω.",statusMicErr:"‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ",statusRec:"üü¢ –ó–∞–ø–∏—Å—å –∑–∞–ø—É—â–µ–Ω–∞.",statusReset:"–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö.",statusNormOn:"üü° –†–µ–∂–∏–º –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è.",statusMainOnNoRef:"‚ö†Ô∏è –ù–µ—Ç —ç—Ç–∞–ª–æ–Ω–∞ –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —Å–∞–º–æ–Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ 1.",statusMainOn:"üü¢ –ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –≠—Ç–∞–ª–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.",statusMainDone:"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω.",statusHistEmptyNorm:"–ò—Å—Ç–æ—Ä–∏—è –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–∞.",statusHistEmptyMain:"–ò—Å—Ç–æ—Ä–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—É—Å—Ç–∞.",statusHistDelNorm:"–£–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è.",statusHistDelMain:"–£–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.",signalInfo:"–ù–∞—á–∞–ª–æ: ‚Äî —Å, –ö–æ–Ω–µ—Ü: ‚Äî —Å, –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî —Å"},
  en:{title:"Acoustic Analysis ‚Äî Stage 1: Normalization ‚Üí Stage 2: Main Analysis",startNorm:"Start normalization",finishNorm:"Finish normalization",requestMic:"Allow microphone access",startRec:"Start recording",stopRec:"Stop",reset:"Reset",resetLast:"Reset last",historyTitle:"History of current mode results",historyHint:"In normalization mode ‚Äî absolute energy asymptotes (W¬∑s/m¬≤). In main mode ‚Äî normalized asymptotes (dimensionless, can be >1 or <1).",ready:"Ready.",modeBadgeNorm:"Mode: Normalization",modeBadgeMain:"Mode: Main analysis",yLeft:"Intensity (arb.)",yRightNorm:"Normalized energy (rel.)",yRightRaw:"Energy (W¬∑s/m¬≤ ‚Äî arb.)",histYNorm:"Normalized asymptote (rel.)",histYAbs:"Integral energy (W¬∑s/m¬≤)",histX:"Session # / time",statusReady:"Ready.",statusMicOk:"‚úÖ Microphone access granted.",statusMicErr:"‚ùå Microphone access denied: ",statusRec:"üü¢ Recording‚Ä¶",statusReset:"Data reset.",statusNormOn:"üü° Normalization mode.",statusMainOnNoRef:"‚ö†Ô∏è No normalization baseline ‚Äî self-normalization to 1.",statusMainOn:"üü¢ Normalization complete. Baseline set.",statusMainDone:"‚úÖ Analysis finished.",statusHistEmptyNorm:"Normalization history is empty.",statusHistEmptyMain:"Main-mode history is empty.",statusHistDelNorm:"Last normalization entry deleted.",statusHistDelMain:"Last main-mode entry deleted.",signalInfo:"Start: ‚Äî s, End: ‚Äî s, Duration: ‚Äî s"},
  he:{title:"‚Äè◊†◊ô◊™◊ï◊ó ◊ê◊ß◊ï◊°◊ò◊ô ‚Äî ◊©◊ú◊ë 1: ◊†◊®◊û◊ï◊ú ‚Üí ◊©◊ú◊ë 2: ◊†◊ô◊™◊ï◊ó ◊¢◊ô◊ß◊®◊ô",startNorm:"◊î◊™◊ó◊ú ◊†◊®◊û◊ï◊ú",finishNorm:"◊°◊ô◊ô◊ù ◊†◊®◊û◊ï◊ú",requestMic:"◊ê◊§◊©◊® ◊í◊ô◊©◊î ◊ú◊û◊ô◊ß◊®◊ï◊§◊ï◊ü",startRec:"◊î◊™◊ó◊ú ◊î◊ß◊ú◊ò◊î",stopRec:"◊¢◊¶◊ï◊®",reset:"◊ê◊ô◊§◊ï◊°",resetLast:"◊ê◊ô◊§◊ï◊° ◊ê◊ó◊®◊ï◊ü",historyTitle:"◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊™◊ï◊¶◊ê◊ï◊™ ◊î◊û◊¶◊ë ◊î◊†◊ï◊õ◊ó◊ô",historyHint:"◊ë◊û◊¶◊ë ◊†◊®◊û◊ï◊ú ‚Äî ◊ê◊°◊ô◊û◊§◊ò◊ï◊ò◊ï◊™ ◊ê◊†◊®◊í◊ô◊î ◊û◊ï◊ó◊ú◊ò◊ï◊™ (W¬∑s/m¬≤). ◊ë◊û◊¶◊ë ◊¢◊ô◊ß◊®◊ô ‚Äî ◊ê◊°◊ô◊û◊§◊ò◊ï◊ò◊ï◊™ ◊û◊†◊ï◊®◊û◊ú◊ï◊™ (◊ú◊ú◊ê ◊û◊û◊ì◊ô◊ù, ◊¢◊©◊ï◊ô◊ï◊™ ◊ú◊î◊ô◊ï◊™ >1 ◊ê◊ï <1).",ready:"◊û◊ï◊õ◊ü.",modeBadgeNorm:"◊û◊¶◊ë: ◊†◊®◊û◊ï◊ú",modeBadgeMain:"◊û◊¶◊ë: ◊†◊ô◊™◊ï◊ó ◊¢◊ô◊ß◊®◊ô",yLeft:"◊¢◊ï◊¶◊û◊î (◊ô◊ó' ◊ô◊ó◊°◊ô◊ï◊™)",yRightNorm:"◊ê◊†◊®◊í◊ô◊î ◊û◊†◊ï◊®◊û◊ú◊™ (◊ô◊ó◊°◊ô)",yRightRaw:"◊ê◊†◊®◊í◊ô◊î (W¬∑s/m¬≤ ‚Äî ◊ó◊ô◊©◊ï◊ë ◊ô◊ó◊°◊ô)",histYNorm:"◊ê◊°◊ô◊û◊§◊ò◊ï◊ò◊î ◊û◊†◊ï◊®◊û◊ú◊™ (◊ô◊ó◊°◊ô)",histYAbs:"◊ê◊†◊®◊í◊ô◊î ◊ê◊ô◊†◊ò◊í◊®◊ú◊ô◊™ (W¬∑s/m¬≤)",histX:"◊û◊°' ◊û◊ï◊©◊ë / ◊ñ◊û◊ü",statusReady:"◊û◊ï◊õ◊ü.",statusMicOk:"‚úÖ ◊î◊ï◊¢◊†◊©◊î ◊í◊ô◊©◊î ◊ú◊û◊ô◊ß◊®◊ï◊§◊ï◊ü.",statusMicErr:"‚ùå ◊ê◊ô◊ü ◊í◊ô◊©◊î ◊ú◊û◊ô◊ß◊®◊ï◊§◊ï◊ü: ",statusRec:"üü¢ ◊î◊ß◊ú◊ò◊î‚Ä¶",statusReset:"◊ê◊ô◊§◊ï◊° ◊†◊™◊ï◊†◊ô◊ù.",statusNormOn:"üü° ◊û◊¶◊ë ◊†◊®◊û◊ï◊ú.",statusMainOnNoRef:"‚ö†Ô∏è ◊ê◊ô◊ü ◊ë◊°◊ô◊° ◊†◊®◊û◊ï◊ú ‚Äî ◊†◊®◊û◊ï◊ú ◊ú-1.",statusMainOn:"üü¢ ◊î◊†◊®◊û◊ï◊ú ◊î◊ï◊©◊ú◊ù. ◊†◊ß◊ë◊¢ ◊ë◊°◊ô◊°.",statusMainDone:"‚úÖ ◊î◊†◊ô◊™◊ï◊ó ◊î◊ï◊©◊ú◊ù.",statusHistEmptyNorm:"◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊î◊†◊®◊û◊ï◊ú ◊®◊ô◊ß◊î.",statusHistEmptyMain:"◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊î◊û◊¶◊ë ◊î◊¢◊ô◊ß◊®◊ô ◊®◊ô◊ß◊î.",statusHistDelNorm:"◊†◊û◊ó◊ß◊î ◊î◊®◊©◊ï◊û◊î ◊î◊ê◊ó◊®◊ï◊†◊î ◊©◊ú ◊î◊†◊®◊û◊ï◊ú.",statusHistDelMain:"◊†◊û◊ó◊ß◊î ◊î◊®◊©◊ï◊û◊î ◊î◊ê◊ó◊®◊ï◊†◊î ◊©◊ú ◊î◊û◊¶◊ë ◊î◊¢◊ô◊ß◊®◊ô.",signalInfo:"◊î◊™◊ó◊ú◊î: ‚Äî ◊©, ◊°◊ï◊£: ‚Äî ◊©, ◊û◊©◊ö: ‚Äî ◊©"}
};
function tr(key){ try{ return (translations[currLang()]||translations.ru)[key] || key; }catch(e){ return key; } }
function setStatus(msg, level='ok'){ const el=document.getElementById('status'); el.className='status '+(level||'ok'); el.textContent=msg; }
function textMatches(el,vars){const t=(el.textContent||'').trim();return vars.some(v=>v===t);}
function findOrBindButton(id,keys){let el=document.getElementById(id);if(el)return el;const btns=Array.from(document.querySelectorAll('button'));for(const b of btns){if(textMatches(b,keys)){b.id=id;return b;}}return null;}
function applyTranslations(lang){
  const t=translations[lang]||translations.ru;
  const title=document.getElementById('titleText'); if(title) title.textContent=t.title;
  const b1=findOrBindButton('btnStartNorm',[translations.ru.startNorm,translations.en.startNorm,translations.he.startNorm]); if(b1) b1.textContent=t.startNorm;
  const b2=findOrBindButton('btnFinishNorm',[translations.ru.finishNorm,translations.en.finishNorm,translations.he.finishNorm]); if(b2) b2.textContent=t.finishNorm;
  const b3=findOrBindButton('btnRequestMic',[translations.ru.requestMic,translations.en.requestMic,translations.he.requestMic]); if(b3) b3.textContent=t.requestMic;
  const b4=findOrBindButton('btnStart',[translations.ru.startRec,translations.en.startRec,translations.he.startRec]); if(b4) b4.textContent=t.startRec;
  const b5=findOrBindButton('btnStop',[translations.ru.stopRec,translations.en.stopRec,translations.he.stopRec]); if(b5) b5.textContent=t.stopRec;
  const b6=findOrBindButton('btnReset',[translations.ru.reset,translations.en.reset,translations.he.reset]); if(b6) b6.textContent=t.reset;
  const b7=findOrBindButton('btnResetLast',[translations.ru.resetLast,translations.en.resetLast,translations.he.resetLast]); if(b7) b7.textContent=t.resetLast;
  const h1=document.querySelector('#historySection h3'); if(h1) h1.textContent=t.historyTitle;
  const hh=document.querySelector('#historySection .hint'); if(hh) hh.textContent=t.historyHint;
  const si=document.getElementById('signalInfo'); if(si && !si.textContent.includes(':')) si.textContent=t.signalInfo;

  // RTL/LTR + persist
  document.body.dir=(lang==='he')?'rtl':'ltr';
  localStorage.setItem(LANG_KEY,lang);

  // ‚úÖ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Ä–µ–∂–∏–º–∞ –∏ –∏—Å—Ç–æ—Ä–∏—é (–ª–µ–≥–µ–Ω–¥—ã)
  try { modeBadge.textContent = (getMode()==='normalization') ? tr('modeBadgeNorm') : tr('modeBadgeMain'); } catch(e){}
  try { drawEnergyHistory(); } catch(e){}

  // —Å—Ç–∞—Ç—É—Å "–≥–æ—Ç–æ–≤"
  try{ setStatus(t.ready,'ok'); }catch(e){}
}
function initI18n(){
  const sel=document.getElementById('langSelect'); if(!sel) return;
  const saved=localStorage.getItem(LANG_KEY)||'ru';
  sel.value=saved; applyTranslations(saved);
  sel.addEventListener('change',e=>{
    applyTranslations(e.target.value);          // —É–∂–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–µ–π–¥–∂ + –∏—Å—Ç–æ—Ä–∏—é
    try{ drawEnergyHistory(); }catch(_){}
  });
}

/* ===== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ / —Ä–µ–∂–∏–º—ã ===== */
let audioCtx=null, micStream=null, analyser=null, source=null, rafId=null;
let recording=false, t0=0, lastT=0;
let signalStartTime = null;
let signalEndTime = null;
let isSignalActive = false;
let maxIntensity = 0;
let lastIntegralValue = 0;
let stableCount = 0;
let autoStopTimer = null;
const MODE_KEY='analysisModeV1';
const ENERGY_HISTORY_KEY='energyHistoryV1';
const ENERGY_HISTORY_MAIN_KEY='energyHistoryMainV1';
const modeBadge=document.getElementById('modeBadge');
const canvas=document.getElementById('mainGraph'), ctx=canvas.getContext('2d');
const historyCanvas=document.getElementById('historyGraph'), hctx=historyCanvas.getContext('2d');
const btnRequestMic=document.getElementById('btnRequestMic');
const btnStart=document.getElementById('btnStart');
const btnStop=document.getElementById('btnStop');
const btnReset=document.getElementById('btnReset');
const btnStartNorm=document.getElementById('btnStartNorm');
const btnFinishNorm=document.getElementById('btnFinishNorm');
const btnResetLast=document.getElementById('btnResetLast');
const signalInfoEl = document.getElementById('signalInfo');

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞
const SIGNAL_THRESHOLD = 0.01; // –ü–æ—Ä–æ–≥ –Ω–∞—á–∞–ª–∞ —Å–∏–≥–Ω–∞–ª–∞
const INTEGRAL_STABILITY_THRESHOLD = 0.01; // 1% –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –∞—Å–∏–º–ø—Ç–æ—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
const STABLE_SAMPLES_REQUIRED = 10; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –æ—Ç—Å—á–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω—Ü–∞
const AUTO_STOP_AFTER_END = 3.0; // –ê–≤—Ç–æ—Å—Ç–æ–ø —á–µ—Ä–µ–∑ 3 —Å–µ–∫ –ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ —Å–∏–≥–Ω–∞–ª–∞
const MAX_RECORDING_TIME = 30.0; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ 30 —Å–µ–∫

function getMode(){const v=localStorage.getItem(MODE_KEY); return (v==='main'||v==='normalization')?v:'normalization';}
function setMode(v){localStorage.setItem(MODE_KEY,v); applyMode();}
function applyMode(){const mode=getMode(); modeBadge.textContent=(mode==='normalization')?tr('modeBadgeNorm'):tr('modeBadgeMain'); document.body.setAttribute('data-mode',mode); drawEnergyHistory();}

/* ===== –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ ===== */
function checkAutoStop(currentTime) {
  const elapsedTime = currentTime - t0;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∏
  if (elapsedTime >= MAX_RECORDING_TIME) {
    setStatus('‚è±Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ (30 —Å–µ–∫) –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ', 'warn');
    stopRecordingAndFinalize();
    return true;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Å—Ç–æ–ø–∞ –ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ —Å–∏–≥–Ω–∞–ª–∞
  if (signalEndTime !== null) {
    const timeSinceEnd = elapsedTime - signalEndTime;
    if (timeSinceEnd >= AUTO_STOP_AFTER_END) {
      setStatus('‚è±Ô∏è –ê–≤—Ç–æ—Å—Ç–æ–ø: –ø—Ä–æ—à–ª–æ 3 —Å–µ–∫ –ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ —Å–∏–≥–Ω–∞–ª–∞', 'ok');
      stopRecordingAndFinalize();
      return true;
    }
  }
  
  return false;
}

/* ===== –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Å–∏–≥–Ω–∞–ª–∞ ===== */
function detectSignal(intensity, currentIntegral, currentTime) {
  const timeFromStart = currentTime - t0;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
  maxIntensity = Math.max(maxIntensity, intensity);
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ (–ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏)
  const relativeThreshold = maxIntensity * 0.02;
  const actualThreshold = Math.max(SIGNAL_THRESHOLD, relativeThreshold);
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ —Å–∏–≥–Ω–∞–ª–∞
  if (!isSignalActive && intensity > actualThreshold) {
    isSignalActive = true;
    signalStartTime = timeFromStart;
    lastIntegralValue = currentIntegral;
    stableCount = 0;
    return 'start';
  }
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—Ü —Å–∏–≥–Ω–∞–ª–∞ –ø–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ–π –∫—Ä–∏–≤–æ–π
  if (isSignalActive && currentIntegral > 0) {
    const relativeChange = Math.abs((currentIntegral - lastIntegralValue) / currentIntegral);
    
    if (relativeChange <= INTEGRAL_STABILITY_THRESHOLD) {
      stableCount++;
      
      if (stableCount >= STABLE_SAMPLES_REQUIRED && signalEndTime === null) {
        isSignalActive = false;
        // –ë–µ—Ä–µ–º –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –Ω–∞—á–∞–ª–∞—Å—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –æ—Ç—Å—á–µ—Ç–æ–≤)
        signalEndTime = timeFromStart - (stableCount * (currentTime - lastT));
        stableCount = 0;
        return 'end';
      }
    } else {
      // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
      stableCount = 0;
      lastIntegralValue = currentIntegral;
    }
  }
  
  return null;
}

function updateSignalInfo() {
  if (signalStartTime !== null && signalEndTime !== null) {
    const duration = signalEndTime - signalStartTime;
    signalInfoEl.textContent = `–ù–∞—á–∞–ª–æ: ${signalStartTime.toFixed(2)} —Å, –ö–æ–Ω–µ—Ü: ${signalEndTime.toFixed(2)} —Å, –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${duration.toFixed(2)} —Å`;
  } else if (signalStartTime !== null) {
    const currentTime = audioCtx ? audioCtx.currentTime - t0 : 0;
    signalInfoEl.textContent = `–ù–∞—á–∞–ª–æ: ${signalStartTime.toFixed(2)} —Å, –ö–æ–Ω–µ—Ü: ‚Äî —Å, –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî —Å`;
  } else {
    signalInfoEl.textContent = tr('signalInfo');
  }
}

/* ===== –ò—Å—Ç–æ—Ä–∏–∏ ===== */
function loadEnergyHistory(){try{const r=localStorage.getItem(ENERGY_HISTORY_KEY); return r?JSON.parse(r):[]}catch{return[]}}
function saveEnergyHistory(a){try{localStorage.setItem(ENERGY_HISTORY_KEY,JSON.stringify(a))}catch{}}
function addEnergyHistoryEntry(e){const d=new Date(); d.setSeconds(0,0); const h=loadEnergyHistory(); h.push({ts:d.toISOString(),energy:Number(e)||0}); saveEnergyHistory(h);}
function loadEnergyHistoryMain(){try{const r=localStorage.getItem(ENERGY_HISTORY_MAIN_KEY); return r?JSON.parse(r):[]}catch{return[]}}
function saveEnergyHistoryMain(a){try{localStorage.setItem(ENERGY_HISTORY_MAIN_KEY,JSON.stringify(a))}catch{}}
function addEnergyHistoryEntryMain(n){const d=new Date(); d.setSeconds(0,0); const h=loadEnergyHistoryMain(); h.push({ts:d.toISOString(),norm:Number(n)||0}); saveEnergyHistoryMain(h);}
function getNormalizationReference(){const h=loadEnergyHistory(); if(!h.length)return null; let m=-Infinity; for(const x of h){const v=Number(x.energy)||0; if(v>m)m=v;} return (isFinite(m)&&m>0)?m:null;}

/* ===== –ò—Å—Ç–æ—Ä–∏—è: –≥—Ä–∞—Ñ–∏–∫ ===== */
function drawEnergyHistory(){
  const mode=getMode(), isMain=(mode==='main');
  const data=isMain?loadEnergyHistoryMain():loadEnergyHistory();
  hctx.clearRect(0,0,historyCanvas.width,historyCanvas.height);
  if(!data.length){hctx.fillStyle='#555'; hctx.font='14px Arial'; hctx.fillText(isMain?tr('statusHistEmptyMain'):tr('statusHistEmptyNorm'),20,30);return;}
  const vals=data.map(d=>isMain?(+d.norm||0):(+d.energy||0)); const maxV=Math.max(...vals)||1;
  const leftPad=50,bottomPad=28,rightPad=20,topPad=12; const W=historyCanvas.width-leftPad-rightPad,H=historyCanvas.height-topPad-bottomPad;
  hctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid'); hctx.lineWidth=1;
  for(let i=0;i<=4;i++){const y=topPad+H-(H*i/4);hctx.beginPath();hctx.moveTo(leftPad,y);hctx.lineTo(leftPad+W,y);hctx.stroke();hctx.fillStyle='#555';hctx.font='11px Arial';const v=maxV*i/4;const lab=isMain?v.toFixed(2):v.toExponential(2);hctx.fillText(lab,6,y-2);}
  hctx.strokeStyle='#000';hctx.beginPath();hctx.moveTo(leftPad,topPad);hctx.lineTo(leftPad,topPad+H);hctx.lineTo(leftPad+W,topPad+H);hctx.stroke();
  hctx.fillStyle='#000';hctx.font='12px Arial';hctx.fillText(tr('histX'),leftPad+W/2-60,topPad+H+22);hctx.save();hctx.rotate(-Math.PI/2);hctx.fillText(isMain?tr('histYNorm'):tr('histYAbs'),-topPad-H/2-80,15);hctx.restore();
  hctx.beginPath(); const N=data.length; for(let i=0;i<N;i++){const x=leftPad+(W*(i/Math.max(1,N-1))); const y=topPad+H-(H*(vals[i]/maxV)); if(i===0)hctx.moveTo(x,y); else hctx.lineTo(x,y);} hctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--green'); hctx.lineWidth=2; hctx.stroke();
  hctx.fillStyle='#111';hctx.font='10px Arial';const step=Math.ceil(N/8); for(let i=0;i<N;i++){const x=leftPad+(W*(i/Math.max(1,N-1))); const y=topPad+H-(H*(vals[i]/maxV)); hctx.beginPath();hctx.arc(x,y,2.5,0,Math.PI*2);hctx.fill(); if(i%step===0||i===N-1){const d=new Date(data[i].ts); const lab=d.toLocaleString(undefined,{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});hctx.fillText(lab,x-32,topPad+H+14);}}
}

/* ===== –°–±—Ä–æ—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ (—Å –∞–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä–æ–º) ===== */
function removeLastHistoryEntry(){
  const mode=getMode();
  if(mode==='main'){const h=loadEnergyHistoryMain(); if(!h.length){setStatus(tr('statusHistEmptyMain'),'warn');return;} h.pop(); saveEnergyHistoryMain(h); setStatus(tr('statusHistDelMain'),'ok');}
  else{const h=loadEnergyHistory(); if(!h.length){setStatus(tr('statusHistEmptyNorm'),'warn');return;} h.pop(); saveEnergyHistory(h); setStatus(tr('statusHistDelNorm'),'ok');}
  drawEnergyHistory();
}
if(btnResetLast) btnResetLast.addEventListener('click',removeLastHistoryEntry);
let _resetHoldTimer=null, _resetRepeatTimer=null; const _initialDelayMs=600, _repeatEveryMs=250;
function _startResetAutoRepeat(){ if(_resetHoldTimer||_resetRepeatTimer) return; _resetHoldTimer=setTimeout(()=>{ removeLastHistoryEntry(); _resetRepeatTimer=setInterval(removeLastHistoryEntry,_repeatEveryMs); }, _initialDelayMs); }
function _stopResetAutoRepeat(){ if(_resetHoldTimer){clearTimeout(_resetHoldTimer);_resetHoldTimer=null;} if(_resetRepeatTimer){clearInterval(_resetRepeatTimer);_resetRepeatTimer=null;} }
if(btnResetLast){ btnResetLast.addEventListener('mousedown',e=>{ if(e.button===0) _startResetAutoRepeat();}); window.addEventListener('mouseup',_stopResetAutoRepeat); btnResetLast.addEventListener('mouseleave',_stopResetAutoRepeat); btnResetLast.addEventListener('touchstart',e=>{e.preventDefault();_startResetAutoRepeat();},{passive:false}); window.addEventListener('touchend',_stopResetAutoRepeat); window.addEventListener('touchcancel',_stopResetAutoRepeat); btnResetLast.addEventListener('contextmenu',e=>e.preventDefault());}

/* ===== –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ + —Å–µ–∫—É–Ω–¥–Ω–∞—è —Å–µ—Ç–∫–∞ ===== */
function mapValToY(val,minV,maxV){const h=canvas.height,p=(val-minV)/(maxV-minV||1);return(h-1)-p*(h-1);}
function drawGraph(intensityValues,secondSeries,isNorm=false){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // —Å–µ–∫. —Å–µ—Ç–∫–∞ –ø–æ X
  try{
    const totalTime = Math.max((typeof lastT!=='undefined' && typeof t0!=='undefined') ? (lastT - t0) : 0, 0);
    if (totalTime > 0.001){
      const secs = Math.floor(totalTime);
      const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--grid') || '#e9e9e9';
      ctx.strokeStyle = gridColor;
      ctx.lineWidth = 1;
      ctx.textAlign = 'center';
      ctx.fillStyle = '#555';
      ctx.font = '11px Arial';
      for (let s=0; s<=secs; s++){
        const x = (s / totalTime) * canvas.width;
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        if (s % 5 === 0){ ctx.save(); ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); ctx.restore(); }
        ctx.fillText(String(s), x, canvas.height - 6);
      }
      ctx.textAlign = 'left';
    }
  }catch(e){}

  // —à–∫–∞–ª—ã
  let maxI=Math.max(...intensityValues)||1, maxS=Math.max(...secondSeries)||1;
  const maxIfs=maxI*1.05, maxSfs=maxS*1.1;

  // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞ –ø–æ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid');
  for(let i=0;i<=5;i++){const y=mapValToY(maxIfs*i/5,0,maxIfs);ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}

  // –æ—Å–∏
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--axes');ctx.beginPath();ctx.moveTo(0,canvas.height-1);ctx.lineTo(canvas.width,canvas.height-1);ctx.moveTo(0,0);ctx.lineTo(0,canvas.height);ctx.stroke();

  // –ø–æ–¥–ø–∏—Å–∏ –ª–µ–≤–æ–π –æ—Å–∏ (–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å)
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text');ctx.font='12px Arial';ctx.textAlign='left';
  for(let i=0;i<=5;i++){const v=maxIfs*i/5,y=mapValToY(v,0,maxIfs);ctx.fillText(v.toExponential(2),5,y-3);}
  ctx.save();ctx.rotate(-Math.PI/2);ctx.fillText(tr('yLeft'),-canvas.height+10,14);ctx.restore();

  // –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∞–≤–æ–π –æ—Å–∏ (—ç–Ω–µ—Ä–≥–∏—è / –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
  ctx.textAlign='right';
  for(let i=0;i<=5;i++){const v=maxSfs*i/5,y=mapValToY(v,0,maxSfs);ctx.fillText(isNorm?v.toFixed(2):v.toExponential(2),canvas.width-5,y-3);}
  ctx.save();ctx.rotate(Math.PI/2);ctx.fillText(isNorm?tr('yRightNorm'):tr('yRightRaw'),canvas.height/2-60,canvas.width-10);ctx.restore();

  // –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
  ctx.beginPath(); for(let i=0;i<intensityValues.length;i++){const x=(i/Math.max(intensityValues.length-1,1))*canvas.width;const y=mapValToY(intensityValues[i],0,maxIfs);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);} ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--blue');ctx.lineWidth=2;ctx.stroke();

  // –≤—Ç–æ—Ä–∞—è –∫—Ä–∏–≤–∞—è
  ctx.beginPath(); for(let i=0;i<secondSeries.length;i++){const x=(i/Math.max(secondSeries.length-1,1))*canvas.width;const y=mapValToY(secondSeries[i],0,maxSfs);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);} ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--green');ctx.lineWidth=2;ctx.stroke();

  // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∞—è –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
  if (secondSeries.length>1){
    const last = secondSeries[secondSeries.length-1];
    const y = mapValToY(last, 0, maxSfs);
    ctx.beginPath(); ctx.setLineDash([5,3]); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--green-dark'); ctx.lineWidth=1; ctx.stroke(); ctx.setLineDash([]);
  }

  // –†–∏—Å—É–µ–º –º–∞—Ä–∫–µ—Ä—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Å–∏–≥–Ω–∞–ª–∞
  if (signalStartTime !== null) {
    const totalTime = lastT - t0;
    if (totalTime > 0) {
      const xStart = (signalStartTime / totalTime) * canvas.width;
      ctx.beginPath();
      ctx.setLineDash([5, 3]);
      ctx.moveTo(xStart, 0);
      ctx.lineTo(xStart, canvas.height);
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--signal-start') || '#ff6b00';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.setLineDash([]);
      
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--signal-start') || '#ff6b00';
      ctx.font = '12px Arial';
      ctx.fillText('–ù–∞—á–∞–ª–æ', xStart + 5, 15);
    }
  }
  
  if (signalEndTime !== null) {
    const totalTime = lastT - t0;
    if (totalTime > 0) {
      const xEnd = (signalEndTime / totalTime) * canvas.width;
      ctx.beginPath();
      ctx.setLineDash([5, 3]);
      ctx.moveTo(xEnd, 0);
      ctx.lineTo(xEnd, canvas.height);
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--signal-end') || '#ff0066';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.setLineDash([]);
      
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--signal-end') || '#ff0066';
      ctx.font = '12px Arial';
      ctx.fillText('–ö–æ–Ω–µ—Ü', xEnd + 5, 30);
    }
  }
}

/* ===== –ú–∏–∫—Ä–æ—Ñ–æ–Ω ===== */
async function requestMicrophoneAccess(){
  try{
    micStream=await navigator.mediaDevices.getUserMedia({audio:true});
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    analyser=audioCtx.createAnalyser(); analyser.fftSize=2048; source=audioCtx.createMediaStreamSource(micStream); source.connect(analyser);
    setStatus(tr('statusMicOk'),'ok');
  }catch(e){ setStatus(tr('statusMicErr')+e.message,'error'); }
}

/* ===== –ó–∞–ø–∏—Å—å ===== */
let intensityValues=[], integralValues=[];
function rms(b){let a=0;for(let v of b)a+=v*v;return Math.sqrt(a/(b.length||1));}
function tick(){
  if(!recording) return;
  const buffer=new Float32Array(analyser.fftSize); analyser.getFloatTimeDomainData(buffer);
  const r=rms(buffer), intensity=r*r;
  const t=audioCtx.currentTime, dt=Math.max(0,t-lastT); lastT=t;
  const last=(integralValues.length?integralValues[integralValues.length-1]:0);
  const next=last+intensity*dt;
  intensityValues.push(intensity); integralValues.push(next);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Å—Ç–æ–ø
  if (checkAutoStop(t)) {
    return;
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Å–∏–≥–Ω–∞–ª–∞
  const signalEvent = detectSignal(intensity, next, t);
  if (signalEvent === 'start') {
    setStatus('üîä –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–∞—á–∞–ª–æ —Å–∏–≥–Ω–∞–ª–∞', 'ok');
  } else if (signalEvent === 'end') {
    setStatus('üîá –û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–æ–Ω–µ—Ü —Å–∏–≥–Ω–∞–ª–∞', 'ok');
  }
  
  updateSignalInfo();

  const mode=getMode();
  if(mode==='normalization'){
    drawGraph(intensityValues, integralValues, false);
  }else{
    const ref=getNormalizationReference();
    if(ref){
      const norm=integralValues.map(v=>v/ref);
      drawGraph(intensityValues, norm, true);
    }else{
      // fallback: —Å–∞–º–æ–Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫—Ä–∏–≤–æ–π (–∞—Å–∏–º–ø—Ç–æ—Ç–∞ ‚Üí 1)
      const lastNow = integralValues.length ? integralValues[integralValues.length-1] : 1;
      const norm=integralValues.map(v=>v/(lastNow||1));
      drawGraph(intensityValues, norm, true);
    }
  }
  rafId=requestAnimationFrame(tick);
}

function stopRecordingAndFinalize(){
  recording=false; 
  if(rafId) {
    cancelAnimationFrame(rafId);
    rafId = null;
  }
  
  // –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –∞–∫—Ç–∏–≤–µ–Ω, –Ω–æ –Ω–µ –±—ã–ª –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–æ–Ω–µ—Ü, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω–µ—Ü –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É
  if (isSignalActive && signalStartTime !== null && signalEndTime === null) {
    signalEndTime = lastT - t0;
    updateSignalInfo();
  }
  
  const mode=getMode();
  if(mode==='normalization'){
    const last=integralValues.length?integralValues[integralValues.length-1]:0;
    addEnergyHistoryEntry(last);
    setStatus(tr('statusNormOn'),'warn');
  }else{
    const ref=getNormalizationReference();
    const last=integralValues.length?integralValues[integralValues.length-1]:0;
    const norm=ref ? (last/ref) : 1;
    addEnergyHistoryEntryMain(norm);
    setStatus(tr('statusMainDone'),'ok');
  }
  drawEnergyHistory();
}

/* ===== –°–±—Ä–æ—Å ===== */
function resetRecording(){
  recording=false; t0=0; lastT=0; intensityValues=[]; integralValues=[];
  signalStartTime = null;
  signalEndTime = null;
  isSignalActive = false;
  maxIntensity = 0;
  lastIntegralValue = 0;
  stableCount = 0;
  if(rafId) {
    cancelAnimationFrame(rafId);
    rafId = null;
  }
  updateSignalInfo();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  setStatus(tr('statusReset'),'ok');
}

/* ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===== */
function init(){
  initI18n(); applyMode();
  if(btnRequestMic) btnRequestMic.addEventListener('click',requestMicrophoneAccess);
  if(btnStart) btnStart.addEventListener('click',()=>{
    if(!analyser){ setStatus('–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω.','error'); return; }
    resetRecording();
    recording=true; t0=audioCtx.currentTime; lastT=t0;
    setStatus(tr('statusRec'),'ok');
    tick();
  });
  if(btnStop) btnStop.addEventListener('click',stopRecordingAndFinalize);
  if(btnReset) btnReset.addEventListener('click',resetRecording);
  if(btnStartNorm) btnStartNorm.addEventListener('click',()=>setMode('normalization'));
  if(btnFinishNorm) btnFinishNorm.addEventListener('click',()=>setMode('main'));
  drawEnergyHistory();
}
window.addEventListener('load',init);
</script>
</body>
</html>