<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Acoustic Analysis ‚Äî Normalization / Main</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --grid:#e9e9e9;
    --axes:#222;
    --text:#111;
    --blue:#2f6fed;
    --green:#1aab55;
    --green-dark:#0f6e35;
    --warn:#b15d00;
    --ok:#0a7a2e;
    --error:#b00020;
    --signal-start:#ff6b00;
    --signal-end:#ff0066;
  }
  body{font-family:Arial, sans-serif; margin:0; background:#fff; color:#111;}
  header{position:relative; padding:10px 12px; border-bottom:1px solid #ddd; background:#fafafa}
  h1{font-size:18px; margin:4px 0;}
  main{padding:8px 0 18px;}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin:8px 12px;}
  .button{padding:8px 14px; border-radius:8px; border:1px solid #ccc; cursor:pointer; background:#f5f5f5}
  .button.primary{background:#2f6fed; border-color:#2f6fed; color:#fff}
  .button.alt{background:#fbe9e7; border-color:#f5ccbd; color:#5d2a00}
  .button:disabled{opacity:0.5; cursor:not-allowed}
  #modeBadge{margin-left:auto; font-size:12px; padding:4px 8px; border-radius:999px; background:#eef; color:#223;}
  body[data-mode="normalization"] #modeBadge{background:#fff6d6; color:#6b4e00;}
  body[data-mode="main"] #modeBadge{background:#e6ffe7; color:#0a5c10;}
  .card{border:1px solid #ddd; border-radius:10px; padding:10px 12px; background:#fff; margin:8px 12px;}
  .status{margin:8px 12px; font-size:14px;}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.error{color:var(--error)}
  canvas{border:1px solid #ddd; border-radius:6px; margin:8px 12px;}
  .hint{font-size:12px; color:#555; margin:0 12px 12px;}
  #langBox{position:absolute; right:12px; top:10px;}
  #langSelect{padding:6px 10px; border-radius:6px; border:1px solid #ccc;}
  .signal-info{margin:8px 12px; padding:8px; background:#f9f9f9; border-radius:6px; font-family:monospace; font-size:13px;}
  .threshold-info{margin:4px 0; padding:6px; background:#f0f8ff; border-radius:4px; font-family:monospace; font-size:12px; color:#0066cc;}
  
  .low-intensity-warning {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(45deg, #ff0000, #ff8800);
    color: white;
    padding: 20px 30px;
    border-radius: 15px;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    z-index: 1000;
    box-shadow: 0 0 30px rgba(255, 0, 0, 0.7);
    animation: blinkWarning 0.5s infinite alternate;
    border: 3px solid #fff;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  }
  @keyframes blinkWarning {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); box-shadow: 0 0 40px rgba(255, 0, 0, 0.9); }
    100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
  }
  .warning-icon { font-size: 32px; margin-bottom: 10px; display: block; }

  /* Modal (Technical settings) */
  .modal-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; z-index: 1200; }
  .modal-card{ position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 12px; border: 1px solid #ddd; width: min(560px, 92vw); box-shadow: 0 12px 40px rgba(0,0,0,0.25); }
  .modal-header{ padding: 12px 16px; border-bottom: 1px solid #eee; display:flex; align-items:center; gap:8px; }
  .modal-title{ font-weight: 700; font-size:16px; }
  .modal-body{ padding: 14px 16px 18px; }
  .modal-actions{ padding: 10px 16px; border-top: 1px solid #eee; display:flex; justify-content:flex-end; gap:8px; }
</style>
</head>
<body>
<header>
  <h1 id="titleText">–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ‚Äî –≠—Ç–∞–ø 1: ¬´–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª ‚Üí –≠—Ç–∞–ø 2: ¬´–û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑¬ª</h1>
  <div id="langBox">
    <select id="langSelect">
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="en">English</option>
      <option value="he">◊¢◊ë◊®◊ô◊™</option>
    </select>
  </div>
</header>

<main>
  <div class="toolbar" id="normToolbar">
    <button id="btnStartNorm" class="button">–ù–∞—á–∞—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <button id="btnFinishNorm" class="button primary">–ó–∞–∫–æ–Ω—á–∏—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <span id="modeBadge">–†–µ–∂–∏–º: ‚Äî</span>
  </div>

  <div class="toolbar">
    <button id="btnRequestMic" class="button alt">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</button>
    <button id="btnStart" class="button">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <button id="btnStop" class="button">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    <button id="btnReset" class="button">–°–±—Ä–æ—Å</button>
    <button id="btnTech" class="button">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </div>

  <div class="status" id="status">–ì–æ—Ç–æ–≤.</div>
  <canvas id="mainGraph" width="980" height="340"></canvas>
  <div class="signal-info" id="signalInfo"></div>

  <section id="historySection" class="card">
    <h3 style="margin:0 0 6px 0;">–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞</h3>
    <canvas id="historyGraph" width="980" height="240"></canvas>
    <div class="hint">–í —Ä–µ–∂–∏–º–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã —ç–Ω–µ—Ä–≥–∏–∏ (–í—Ç¬∑—Å/–º¬≤). –í –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äî –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã (–±–µ–∑—Ä–∞–∑–º–µ—Ä–Ω—ã–µ, –º–æ–≥—É—Ç –±—ã—Ç—å &gt;1 –∏–ª–∏ &lt;1).</div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:4px;">
      <button id="btnResetLast" class="button">–°–±—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ</button>
    </div>
  </section>
</main>

<!-- Technical settings modal (always English) -->
<div id="techModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="techTitle">
  <div class="modal-card" onclick="event.stopPropagation();">
    <div class="modal-header">
      <span id="techTitle" class="modal-title">Technical settings</span>
    </div>
    <div class="modal-body">
      <div class="threshold-info" id="thresholdInfo">Current threshold: ‚Äî</div>
      <div style="margin-top:10px; font-size:14px;">
        <label for="thrSlider" style="display:block; margin-bottom:6px; font-weight:600;">Relative threshold, %</label>
        <div style="display:flex; align-items:center; gap:10px;">
          <input id="thrSlider" type="range" min="0" max="10" step="0.5" value="5" style="flex:1;">
          <span id="thrValue" style="min-width:56px; text-align:right;">5.0%</span>
        </div>
        <div style="font-size:12px; color:#666; margin-top:6px;">Applies instantly and is saved locally.</div>
      </div>
      <div style="margin-top:14px; font-size:14px;">
        <label for="stabSlider" style="display:block; margin-bottom:6px; font-weight:600;">Stability criterion, %</label>
        <div style="display:flex; align-items:center; gap:10px;">
          <input id="stabSlider" type="range" min="0" max="5" step="0.25" value="1" style="flex:1;">
          <span id="stabValue" style="min-width:56px; text-align:right;">1.00%</span>
        </div>
        <div style="font-size:12px; color:#666; margin-top:6px;">Lower = –±–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é, Higher = –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ.</div>
      </div>
      <div style="font-size:12px;color:#666;margin-top:8px;">
        * Threshold is computed as the maximum of the chosen percent of the current max intensity and an absolute floor.
      </div>
    </div>
    <div class="modal-actions">
      <button id="btnCloseTech" class="button">Close</button>
    </div>
  </div>
</div>

<div id="lowIntensityWarning" class="low-intensity-warning" style="display: none;">
  <span class="warning-icon">‚ö†Ô∏è</span>
  –ù–ò–ó–ö–ê–Ø –ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨ –°–ò–ì–ù–ê–õ–ê!<br>
  –£–≤–µ–ª–∏—á—å—Ç–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å!
</div>

<script>
/* I18N (RU/EN/HE) */
const LANG_KEY='ui_lang_v1';
function currLang(){ return localStorage.getItem(LANG_KEY)||'ru'; }
const translations={
  ru:{title:"–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ‚Äî –≠—Ç–∞–ø 1: ¬´–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª ‚Üí –≠—Ç–∞–ø 2: ¬´–û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑¬ª",startNorm:"–ù–∞—á–∞—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ",finishNorm:"–ó–∞–∫–æ–Ω—á–∏—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ",requestMic:"–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É",startRec:"–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å",stopRec:"–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",reset:"–°–±—Ä–æ—Å",resetLast:"–°–±—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ",historyTitle:"–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞",historyHint:"–í —Ä–µ–∂–∏–º–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã —ç–Ω–µ—Ä–≥–∏–∏ (–í—Ç¬∑—Å/–º¬≤). –í –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äî –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã (–±–µ–∑—Ä–∞–∑–º–µ—Ä–Ω—ã–µ, –º–æ–≥—É—Ç –±—ã—Ç—å >1 –∏–ª–∏ <1).",ready:"–ì–æ—Ç–æ–≤.",modeBadgeNorm:"–†–µ–∂–∏–º: –ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ",modeBadgeMain:"–†–µ–∂–∏–º: –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑",yLeft:"–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (—É—Å–ª. –µ–¥.)",yRightNorm:"–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è (–æ—Ç–Ω.)",yRightRaw:"–≠–Ω–µ—Ä–≥–∏—è (–í—Ç¬∑—Å/–º¬≤ ‚Äî —É—Å–ª.)",histYNorm:"–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Å–∏–º–ø—Ç–æ—Ç–∞ (–æ—Ç–Ω.)",histYAbs:"–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è (–í—Ç¬∑—Å/–º¬≤)",histX:"‚Ññ —Å–µ–∞–Ω—Å–∞ / –≤—Ä–µ–º—è",statusReady:"–ì–æ—Ç–æ–≤.",statusMicOk:"‚úÖ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω.",statusMicErr:"‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ",statusRec:"üü¢ –ó–∞–ø–∏—Å—å –∑–∞–ø—É—â–µ–Ω–∞.",statusReset:"–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö.",statusNormOn:"üü° –†–µ–∂–∏–º –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è.",statusMainOnNoRef:"‚ö†Ô∏è –ù–µ—Ç —ç—Ç–∞–ª–æ–Ω–∞ –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî —Å–∞–º–æ–Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ 1.",statusMainOn:"üü¢ –ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –≠—Ç–∞–ª–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.",statusMainDone:"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω.",statusHistEmptyNorm:"–ò—Å—Ç–æ—Ä–∏—è –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–∞.",statusHistEmptyMain:"–ò—Å—Ç–æ—Ä–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—É—Å—Ç–∞.",statusHistDelNorm:"–£–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è.",statusHistDelMain:"–£–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.",signalInfo:"–ù–∞—á–∞–ª–æ: ‚Äî —Å, –ö–æ–Ω–µ—Ü: ‚Äî —Å, –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚Äî —Å",startLabel:"–ù–∞—á–∞–ª–æ",endLabel:"–ö–æ–Ω–µ—Ü",durationLabel:"–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",cutLabel:"–¢–æ—á–∫–∞ –æ—Ç—Å–µ—á–µ–Ω–∏—è",secUnit:"—Å"},
  en:{title:"Acoustic Analysis ‚Äî Stage 1: Normalization ‚Üí Stage 2: Main Analysis",startNorm:"Start normalization",finishNorm:"Finish normalization",requestMic:"Allow microphone access",startRec:"Start recording",stopRec:"Stop",reset:"Reset",resetLast:"Reset last",historyTitle:"History of current mode results",historyHint:"In normalization mode ‚Äî absolute energy asymptotes (W¬∑s/m¬≤). In main mode ‚Äî normalized asymptotes (dimensionless, can be >1 or <1).",ready:"Ready.",modeBadgeNorm:"Mode: Normalization",modeBadgeMain:"Mode: Main analysis",yLeft:"Intensity (arb.)",yRightNorm:"Normalized energy (rel.)",yRightRaw:"Energy (W¬∑s/m¬≤ ‚Äî arb.)",histYNorm:"Normalized asymptote (rel.)",histYAbs:"Integral energy (W¬∑s/m¬≤)",histX:"Session # / time",statusReady:"Ready.",statusMicOk:"‚úÖ Microphone access granted.",statusMicErr:"‚ùå Microphone access denied: ",statusRec:"üü¢ Recording‚Ä¶",statusReset:"Data reset.",statusNormOn:"üü° Normalization mode.",statusMainOnNoRef:"‚ö†Ô∏è No normalization baseline ‚Äî self-normalization to 1.",statusMainOn:"üü¢ Normalization complete. Baseline set.",statusMainDone:"‚úÖ Analysis finished.",statusHistEmptyNorm:"Normalization history is empty.",statusHistEmptyMain:"Main-mode history is empty.",statusHistDelNorm:"Last normalization entry deleted.",statusHistDelMain:"Last main-mode entry deleted.",signalInfo:"Start: ‚Äî s, End: ‚Äî s, Duration: ‚Äî s",startLabel:"Start",endLabel:"End",durationLabel:"Duration",cutLabel:"Cutoff point",secUnit:"s"},
  he:{title:"‚Äè◊†◊ô◊™◊ï◊ó ◊ê◊ß◊ï◊°◊ò◊ô ‚Äî ◊©◊ú◊ë 1: ◊†◊®◊û◊ï◊ú ‚Üí ◊©◊ú◊ë 2: ◊†◊ô◊™◊ï◊ó ◊¢◊ô◊ß◊®◊ô",startNorm:"◊î◊™◊ó◊ú ◊†◊®◊û◊ï◊ú",finishNorm:"◊°◊ô◊ô◊ù ◊†◊®◊û◊ï◊ú",requestMic:"◊ê◊§◊©◊® ◊í◊ô◊©◊î ◊ú◊û◊ô◊ß◊®◊ï◊§◊ï◊ü",startRec:"◊î◊™◊ó◊ú ◊î◊ß◊ú◊ò◊î",stopRec:"◊¢◊¶◊ï◊®",reset:"◊ê◊ô◊§◊ï◊°",resetLast:"◊ê◊ô◊§◊ï◊° ◊ê◊ó◊®◊ï◊ü",historyTitle:"◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊™◊ï◊¶◊ê◊ï◊™ ◊î◊û◊¶◊ë ◊î◊†◊ï◊õ◊ó◊ô",historyHint:"◊ë◊û◊¶◊ë ◊†◊®◊û◊ï◊ú ‚Äî ◊ê◊°◊ô◊û◊§◊ò◊ï◊ò◊ï◊™ ◊ê◊†◊®◊í◊ô◊î ◊û◊ï◊ó◊ú◊ò◊ï◊™ (W¬∑s/m¬≤). ◊ë◊û◊¶◊ë ◊¢◊ô◊ß◊®◊ô ‚Äî ◊ê◊°◊ô◊û◊§◊ò◊ï◊ò◊ï◊™ ◊û◊†◊ï◊®◊û◊ú◊ï◊™ (◊ú◊ú◊ê ◊û◊û◊ì◊ô◊ù, ◊¢◊©◊ï◊ô◊ï◊™ ◊ú◊î◊ô◊ï◊™ >1 ◊ê◊ï <1).",ready:"◊û◊ï◊õ◊ü.",modeBadgeNorm:"◊û◊¶◊ë: ◊†◊®◊û◊ï◊ú",modeBadgeMain:"◊û◊¶◊ë: ◊†◊ô◊™◊ï◊ó ◊¢◊ô◊ß◊®◊ô",yLeft:"◊¢◊ï◊¶◊û◊î (◊ô◊ó' ◊ô◊ó◊°◊ô◊ï◊™)",yRightNorm:"◊ê◊†◊®◊í◊ô◊î ◊û◊†◊ï◊®◊û◊ú◊™ (◊ô◊ó◊°◊ô)",yRightRaw:"◊ê◊†◊®◊í◊ô◊î (W¬∑s/m¬≤ ‚Äî ◊ó◊ô◊©◊ï◊ë ◊ô◊ó◊°◊ô)",histYNorm:"◊ê◊°◊ô◊û◊§◊ò◊ï◊ò◊î ◊û◊†◊ï◊®◊û◊ú◊™ (◊ô◊ó◊°◊ô)",histYAbs:"◊ê◊†◊®◊í◊ô◊î ◊ê◊ô◊†◊ò◊í◊®◊ú◊ô◊™ (W¬∑s/m¬≤)",histX:"◊û◊°' ◊û◊ï◊©◊ë / ◊ñ◊û◊ü",statusReady:"◊û◊ï◊õ◊ü.",statusMicOk:"‚úÖ ◊î◊ï◊¢◊†◊ß◊î ◊í◊ô◊©◊î ◊ú◊û◊ô◊ß◊®◊ï◊§◊ï◊ü.",statusMicErr:"‚ùå ◊ê◊ô◊ü ◊í◊ô◊©◊î ◊ú◊û◊ô◊ß◊®◊ï◊§◊§◊ï◊ü: ",statusRec:"üü¢ ◊î◊ß◊ú◊ò◊î‚Ä¶",statusReset:"◊ê◊ô◊§◊ï◊° ◊†◊™◊ï◊†◊ô◊ù.",statusMainOnNoRef:"‚ö†Ô∏è ◊ê◊ô◊ü ◊ë◊°◊ô◊° ◊†◊®◊û◊ï◊ú ‚Äî ◊†◊®◊û◊ï◊ú ◊ú-1.",statusMainOn:"üü¢ ◊î◊†◊®◊û◊ï◊ú ◊î◊ï◊©◊ú◊ù. ◊†◊ß◊ë◊¢ ◊ë◊°◊ô◊°.",statusMainDone:"‚úÖ ◊î◊†◊ô◊™◊ï◊ó ◊î◊ï◊©◊ú◊ù.",statusHistEmptyNorm:"◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊î◊†◊®◊û◊ï◊ú ◊®◊ô◊ß◊î.",statusHistEmptyMain:"◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊î◊û◊¶◊ë ◊î◊¢◊ô◊ß◊®◊ô ◊®◊ô◊ß◊î.",statusHistDelNorm:"◊†◊û◊ó◊ß◊î ◊î◊®◊©◊ï◊û◊î ◊î◊ê◊ó◊®◊ï◊†◊î ◊©◊ú ◊î◊†◊®◊û◊ï◊ú.",statusHistDelMain:"◊†◊û◊ó◊ß◊î ◊î◊®◊©◊ï◊û◊î ◊î◊ê◊ó◊®◊ï◊†◊î ◊©◊ú ◊î◊û◊¶◊ë ◊î◊¢◊ô◊ß◊®◊ô.",signalInfo:"◊î◊™◊ó◊ú◊î: ‚Äî ◊©, ◊°◊ï◊£: ‚Äî ◊©, ◊û◊©◊ö: ‚Äî ◊©",startLabel:"◊î◊™◊ó◊ú◊î",endLabel:"◊°◊ï◊£",durationLabel:"◊û◊©◊ö",cutLabel:"◊†◊ß◊ï◊ì◊™ ◊ó◊ô◊™◊ï◊ö",secUnit:"◊©"}
};
function tr(key){ try{ return (translations[currLang()]||translations.ru)[key] || key; }catch(e){ return key; } }
function setStatus(msg, level='ok'){ const el=document.getElementById('status'); el.className='status '+(level||'ok'); el.textContent=msg; }
function setThresholdInfo(msg){ const el=document.getElementById('thresholdInfo'); if(el) el.textContent=msg; }
function textMatches(el,vars){const t=(el.textContent||'').trim();return vars.some(v=>v===t);}
function findOrBindButton(id,keys){let el=document.getElementById(id);if(el)return el;const btns=Array.from(document.querySelectorAll('button'));for(const b of btns){if(textMatches(b,keys)){b.id=id;return b;}}return null;}
function applyTranslations(lang){
  const t=translations[lang]||translations.ru;
  const title=document.getElementById('titleText'); if(title) title.textContent=t.title;
  const b1=findOrBindButton('btnStartNorm',[translations.ru.startNorm,translations.en.startNorm,translations.he.startNorm]); if(b1) b1.textContent=t.startNorm;
  const b2=findOrBindButton('btnFinishNorm',[translations.ru.finishNorm,translations.en.finishNorm,translations.he.finishNorm]); if(b2) b2.textContent=t.finishNorm;
  const b3=findOrBindButton('btnRequestMic',[translations.ru.requestMic,translations.en.requestMic,translations.he.requestMic]); if(b3) b3.textContent=t.requestMic;
  const b4=findOrBindButton('btnStart',[translations.ru.startRec,translations.en.startRec,translations.he.startRec]); if(b4) b4.textContent=t.startRec;
  const b5=findOrBindButton('btnStop',[translations.ru.stopRec,translations.en.stopRec,translations.he.stopRec]); if(b5) b5.textContent=t.stopRec;
  const b6=findOrBindButton('btnReset',[translations.ru.reset,translations.en.reset,translations.he.reset]); if(b6) b6.textContent=t.reset;
  const b7=findOrBindButton('btnResetLast',[translations.ru.resetLast,translations.en.resetLast,translations.he.resetLast]); if(b7) b7.textContent=t.resetLast;
  const h1=document.querySelector('#historySection h3'); if(h1) h1.textContent=t.historyTitle;
  const hh=document.querySelector('#historySection .hint'); if(hh) hh.textContent=t.historyHint;
  const bTech=findOrBindButton('btnTech',[translations.ru.techSettings||"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏","Technical settings",translations.he.techSettings||"◊î◊í◊ì◊®◊ï◊™ ◊ò◊õ◊†◊ô◊ï◊™"]); if(bTech) bTech.textContent=(lang==='ru'?"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏":lang==='he'?"◊î◊í◊ì◊®◊ï◊™ ◊ò◊õ◊†◊ô◊ï◊™":"Technical settings");
  document.body.dir=(lang==='he')?'rtl':'ltr';
  localStorage.setItem(LANG_KEY,lang);
  try{ updateSignalInfo(); }catch(e){}
  try { modeBadge.textContent = (getMode()==='normalization') ? tr('modeBadgeNorm') : tr('modeBadgeMain'); } catch(e){}
  try { drawEnergyHistory(); } catch(e){}
  try{ setStatus(t.ready,'ok'); }catch(e){}
}

/* Modes & elements */
let audioCtx=null, micStream=null, analyser=null, source=null, rafId=null;
let sampleTimes=[];
let cutTimeAbs=null, cutPointPercent=null;

let recording=false, t0=0, lastT=0;
let signalStartTime = null;
let signalEndTime = null;
let isSignalActive = false;
let maxIntensity = 0;
let lastIntegralValue = 0;
let stableCount = 0;
let currentThreshold = 0;
let lowIntensityWarningActive = false;
let warningTimeout = null;
const MODE_KEY='analysisModeV1';
const ENERGY_HISTORY_KEY='energyHistoryV1';
const ENERGY_HISTORY_MAIN_KEY='energyHistoryMainV1';
const modeBadge=document.getElementById('modeBadge');
const canvas=document.getElementById('mainGraph'), ctx=canvas.getContext('2d');
const historyCanvas=document.getElementById('historyGraph'), hctx=historyCanvas.getContext('2d');
const btnRequestMic=document.getElementById('btnRequestMic');
const btnStart=document.getElementById('btnStart');
const btnStop=document.getElementById('btnStop');
const btnReset=document.getElementById('btnReset');
const btnStartNorm=document.getElementById('btnStartNorm');
const btnFinishNorm=document.getElementById('btnFinishNorm');
const btnResetLast=document.getElementById('btnResetLast');
const btnTech=document.getElementById('btnTech');
const btnCloseTech=document.getElementById('btnCloseTech');
const techModal=document.getElementById('techModal');
const signalInfoEl = document.getElementById('signalInfo');
const lowIntensityWarning = document.getElementById('lowIntensityWarning');

/* Threshold slider persistence */
const THRESHOLD_PCT_KEY = 'thr_pct_v1';
function getThresholdPct(){
  let v = parseFloat(localStorage.getItem(THRESHOLD_PCT_KEY));
  if (!(v>=0 && v<=10)) v = 5;
  return v;
}
function setThresholdPct(v){
  v = Math.max(0, Math.min(10, Number(v)||0));
  localStorage.setItem(THRESHOLD_PCT_KEY, String(v));
}
function getRelativeThresholdFraction(){
  return getThresholdPct() / 100;
}

/* Stability slider persistence */
const STABILITY_PCT_KEY = 'stability_pct_v1';
function getStabilityPct(){
  let v = parseFloat(localStorage.getItem(STABILITY_PCT_KEY));
  if (!(v>=0 && v<=5)) v = 1;
  return v;
}
function setStabilityPct(v){
  v = Math.max(0, Math.min(5, Number(v)||0));
  localStorage.setItem(STABILITY_PCT_KEY, String(v));
}
function getStabilityCriterion(){
  return getStabilityPct() / 100;
}

const ABSOLUTE_FLOOR = 0.001;
// const INTEGRAL_STABILITY_THRESHOLD = 0.01; // replaced by getStabilityCriterion()
const STABLE_SAMPLES_REQUIRED = 10;
const AUTO_STOP_AFTER_END = 3.0;
const MAX_RECORDING_TIME = 30.0;

function getMode(){const v=localStorage.getItem(MODE_KEY); return (v==='main'||v==='normalization')?v:'normalization';}
function setMode(v){localStorage.setItem(MODE_KEY,v); applyMode();}
function applyMode(){const mode=getMode(); modeBadge.textContent=(mode==='normalization')?tr('modeBadgeNorm'):tr('modeBadgeMain'); document.body.setAttribute('data-mode',mode); drawEnergyHistory();}

/* Warnings */
function showLowIntensityWarning() {
  if (!lowIntensityWarningActive) {
    lowIntensityWarningActive = true;
    lowIntensityWarning.style.display = 'block';
    if (warningTimeout) clearTimeout(warningTimeout);
    warningTimeout = setTimeout(() => { hideLowIntensityWarning(); }, 5000);
  }
}
function hideLowIntensityWarning() {
  lowIntensityWarningActive = false;
  lowIntensityWarning.style.display = 'none';
  if (warningTimeout) { clearTimeout(warningTimeout); warningTimeout = null; }
}

/* Modal helpers */
function openTech(){ 
  techModal.style.display='block'; 
  try{
    const rel = Math.max(maxIntensity * getRelativeThresholdFraction(), ABSOLUTE_FLOOR);
    setThresholdInfo(`Current threshold: ${rel.toExponential(2)} (${getThresholdPct().toFixed(1)}% of max ${maxIntensity>0?maxIntensity.toExponential(2):'‚Äî'})`);
    const slider = document.getElementById('thrSlider');
    const out = document.getElementById('thrValue');
    if (slider && out){
      const pct = getThresholdPct();
      slider.value = String(pct);
      out.textContent = pct.toFixed(1) + '%';
    }
    const s2 = document.getElementById('stabSlider');
    const o2 = document.getElementById('stabValue');
    if (s2 && o2){
      const pct2 = getStabilityPct();
      s2.value = String(pct2);
      o2.textContent = pct2.toFixed(2) + '%';
    }
  }catch(e){}
}
function closeTech(){ techModal.style.display='none'; }

/* AutoStop & decorations */
function checkAutoStop(currentTime) {
  const elapsedTime = currentTime - t0;
  if (elapsedTime >= MAX_RECORDING_TIME) {
    setStatus('‚è±Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ (30 —Å–µ–∫) –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ', 'warn');
    stopRecordingAndFinalize();
    return true;
  }
  try {
    const mode = getMode();
    const refNow = getNormalizationReference();
    if (mode==='main' && !refNow && cutTimeAbs!==null) {
      const totalTime = lastT - t0;
      if (totalTime > 0) {
        const xCut = (cutTimeAbs / totalTime) * canvas.width;
        ctx.beginPath();
        ctx.setLineDash([4, 4]);
        ctx.moveTo(xCut, 0);
        ctx.lineTo(xCut, canvas.height);
        ctx.strokeStyle = '#444';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = '#333';
        ctx.font = 'bold 12px Arial';
        ctx.fillText('+1—Å', xCut + 5, 45);
      }
    }
  } catch(e) {}
  if (signalEndTime !== null) {
    const timeSinceEnd = elapsedTime - signalEndTime;
    if (timeSinceEnd >= AUTO_STOP_AFTER_END) {
      setStatus('‚è±Ô∏è –ê–≤—Ç–æ—Å—Ç–æ–ø: –ø—Ä–æ—à–ª–æ 3 —Å–µ–∫ –ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ —Å–∏–≥–Ω–∞–ª–∞', 'ok');
      stopRecordingAndFinalize();
      return true;
    }
  }
  return false;
}

/* Signal detection */
function detectSignal(intensity, currentIntegral, currentTime) {
  const timeFromStart = currentTime - t0;
  maxIntensity = Math.max(maxIntensity, intensity);
  const relativeThreshold = Math.max(maxIntensity * getRelativeThresholdFraction(), ABSOLUTE_FLOOR);
  currentThreshold = relativeThreshold;
  setThresholdInfo(`Current threshold: ${relativeThreshold.toExponential(2)} (${getThresholdPct().toFixed(1)}% of max ${maxIntensity.toExponential(2)})`);
  if (maxIntensity < ABSOLUTE_FLOOR * 2) {
    setStatus('‚ö†Ô∏è –ù–ò–ó–ö–ê–Ø –ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨ –°–ò–ì–ù–ê–õ–ê! –£–≤–µ–ª–∏—á—å—Ç–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å.', 'warn');
    showLowIntensityWarning();
  } else {
    if (document.getElementById('status').textContent.includes('–ù–ò–ó–ö–ê–Ø –ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨')) {
      setStatus(tr('statusRec'), 'ok');
    }
    hideLowIntensityWarning();
  }
  if (!isSignalActive && intensity > relativeThreshold) {
    isSignalActive = true;
    signalStartTime = timeFromStart;
    lastIntegralValue = currentIntegral;
    stableCount = 0;
    return 'start';
  }
  if (isSignalActive && currentIntegral > 0) {
    const relativeChange = Math.abs((currentIntegral - lastIntegralValue) / currentIntegral);
    if (relativeChange <= getStabilityCriterion()) {
      stableCount++;
      if (stableCount >= STABLE_SAMPLES_REQUIRED && signalEndTime === null) {
        isSignalActive = false;
        signalEndTime = timeFromStart - (stableCount * (currentTime - lastT));
        stableCount = 0;
        return 'end';
      }
    } else {
      stableCount = 0;
      lastIntegralValue = currentIntegral;
    }
  }
  if (signalEndTime !== null && intensity > relativeThreshold) {
    return null;
  }
  return null;
}

function composeSignalInfoText(){
  const startLbl = tr('startLabel');
  const endLbl = tr('endLabel');
  const durLbl = tr('durationLabel');
  const cutLbl = tr('cutLabel');
  const sec = tr('secUnit');
  if (signalStartTime !== null && signalEndTime !== null) {
    const duration = signalEndTime - signalStartTime;
    let line = `${startLbl}: ${signalStartTime.toFixed(2)} ${sec}, ${endLbl}: ${signalEndTime.toFixed(2)} ${sec}, ${durLbl}: ${duration.toFixed(2)} ${sec}`;
    try {
      const mode = getMode();
      if (mode==='main' && !getNormalizationReference() && cutPointPercent!=null) {
        line += `, ${cutLbl}: ${cutPointPercent.toFixed(1)}%`;
      }
    } catch(e) {}
    return line;
  } else if (signalStartTime !== null) {
    let line = `${startLbl}: ${signalStartTime.toFixed(2)} ${sec}, ${endLbl}: ‚Äî ${sec}, ${durLbl}: ‚Äî ${sec}`;
    try {
      const mode = getMode();
      if (mode==='main' && !getNormalizationReference() && cutPointPercent!=null) {
        line += `, ${cutLbl}: ${cutPointPercent.toFixed(1)}%`;
      }
    } catch(e) {}
    return line;
  } else {
    return tr('signalInfo');
  }
}
function updateSignalInfo() {
  const si = document.getElementById('signalInfo');
  if (!si) return;
  si.textContent = composeSignalInfoText();
  if (maxIntensity > 0 && maxIntensity < ABSOLUTE_FLOOR * 2) {
    si.textContent += " ‚ö†Ô∏è –ù–ò–ó–ö–ê–Ø –ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨!";
  }
}

/* History */
function loadEnergyHistory(){ try{const r=localStorage.getItem(ENERGY_HISTORY_KEY); return r?JSON.parse(r):[];}catch(e){return [];} }
function saveEnergyHistory(a){ try{localStorage.setItem(ENERGY_HISTORY_KEY,JSON.stringify(a));}catch(e){} }
function addEnergyHistoryEntry(e){ const d=new Date(); d.setSeconds(0,0); const h=loadEnergyHistory(); h.push({ts:d.toISOString(),energy:Number(e)||0}); saveEnergyHistory(h); }
function loadEnergyHistoryMain(){ try{const r=localStorage.getItem(ENERGY_HISTORY_MAIN_KEY); return r?JSON.parse(r):[];}catch(e){return [];} }
function saveEnergyHistoryMain(a){ try{localStorage.setItem(ENERGY_HISTORY_MAIN_KEY,JSON.stringify(a));}catch(e){} }
function _downsampleSeries(arr, maxPts){ const N = arr.length; if(N<=maxPts) return arr.slice(); const out=[]; for(let i=0;i<maxPts;i++){ const idx=Math.round(i*(N-1)/(maxPts-1)); out.push(arr[idx]); } return out; }
function addEnergyHistoryEntryMain(n){const d=new Date(); d.setSeconds(0,0); const h=loadEnergyHistoryMain(); h.push({ts:d.toISOString(),norm:Number(n)||0}); saveEnergyHistoryMain(h);}
function getNormalizationReference(){const h=loadEnergyHistory(); if(!h.length)return null; let m=-Infinity; for(const x of h){const v=Number(x.energy)||0; if(v>m)m=v;} return (isFinite(m)&&m>0)?m:null;}

function drawEnergyHistory(){
  const mode=getMode(), isMain=(mode==='main');
  const data=isMain?loadEnergyHistoryMain():loadEnergyHistory();
  hctx.clearRect(0,0,historyCanvas.width,historyCanvas.height);
  if(!data.length){hctx.fillStyle='#555'; hctx.font='14px Arial'; hctx.fillText(isMain?tr('statusHistEmptyMain'):tr('statusHistEmptyNorm'),20,30);return;}
  const vals=data.map(d=>isMain?(+d.norm||0):(+d.energy||0)); const maxV=Math.max(...vals)||1;
  const leftPad=50,bottomPad=28,rightPad=20,topPad=12; const W=historyCanvas.width-leftPad-rightPad,H=historyCanvas.height-topPad-bottomPad;
  try {
    if (isMain && !getNormalizationReference()) {
      const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
      const yFromVal = (val) => { const y = topPad + H - (H * (val / (maxV || 1))); return clamp(y, topPad, topPad + H); };
      const y0   = yFromVal(0);
      const y05  = yFromVal(0.5);
      const y08  = yFromVal(0.8);
      const y10  = yFromVal(1.0);
      hctx.fillStyle = 'rgba(255, 0, 0, 0.08)'; hctx.fillRect(leftPad, Math.min(y0, y05), W, Math.abs(y05 - y0));
      hctx.fillStyle = 'rgba(255, 215, 0, 0.10)'; hctx.fillRect(leftPad, Math.min(y05, y08), W, Math.abs(y08 - y05));
      hctx.fillStyle = 'rgba(0, 128, 0, 0.10)'; hctx.fillRect(leftPad, Math.min(y08, y10), W, Math.abs(y10 - y08));
    }
  } catch(e) { }
  hctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid'); hctx.lineWidth=1;
  for(let i=0;i<=4;i++){const y=topPad+H-(H*i/4);hctx.beginPath();hctx.moveTo(leftPad,y);hctx.lineTo(leftPad+W,y);hctx.stroke();hctx.fillStyle='#555';hctx.font='11px Arial';const v=maxV*i/4;const lab=isMain?v.toFixed(2):v.toExponential(2);hctx.fillText(lab,6,y-2);}
  hctx.strokeStyle='#000';hctx.beginPath();hctx.moveTo(leftPad,topPad);hctx.lineTo(leftPad,topPad+H);hctx.lineTo(leftPad+W,topPad+H);hctx.stroke();
  hctx.fillStyle='#000';hctx.font='12px Arial';hctx.fillText(tr('histX'),leftPad+W/2-60,topPad+H+22);hctx.save();hctx.rotate(-Math.PI/2);hctx.fillText(isMain?tr('histYNorm'):tr('histYAbs'),-topPad-H/2-80,15);hctx.restore();
  hctx.beginPath(); const N=data.length; for(let i=0;i<N;i++){const x=leftPad+(W*(i/Math.max(1,N-1))); const y=topPad+H-(H*(vals[i]/maxV)); if(i===0)hctx.moveTo(x,y); else hctx.lineTo(x,y);} hctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--green'); hctx.lineWidth=2; hctx.stroke();
  if (isMain) {
    hctx.beginPath();
    for (let i=0;i<N;i++){ const rec = data[i]||{}; if (typeof rec.cut==='number'){ const x = leftPad + (W*(i/Math.max(1,N-1))); const y = topPad + H - (H*((rec.cut/100)/maxV)); if (i === 0) hctx.moveTo(x, y); else hctx.lineTo(x, y); } }
    hctx.strokeStyle = '#ff0066'; hctx.lineWidth = 1.5; hctx.stroke();
    for (let i=0;i<N;i++){ const rec = data[i]||{}; if (typeof rec.cut==='number'){ const x = leftPad + (W*(i/Math.max(1,N-1))); const y = topPad + H - (H*((rec.cut/100)/maxV)); hctx.beginPath(); hctx.arc(x, y, 4, 0, Math.PI*2); hctx.fillStyle = '#ff0066'; hctx.fill(); } }
  }
  hctx.fillStyle='#111';hctx.font='10px Arial';const step=Math.ceil(N/8);
  for(let i=0;i<N;i++){const x=leftPad+(W*(i/Math.max(1,N-1))); const y=topPad+H-(H*(vals[i]/maxV)); hctx.beginPath();hctx.arc(x,y,2.5,0,Math.PI*2);hctx.fill(); if(i%step===0||i===N-1){const d=new Date(data[i].ts); const lab=d.toLocaleString(undefined,{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});hctx.fillText(lab,x-32,topPad+H+14);}}
}

/* Remove last + auto-repeat */
function removeLastHistoryEntry(){
  const mode=getMode();
  if(mode==='main'){const h=loadEnergyHistoryMain(); if(!h.length){setStatus(tr('statusHistEmptyMain'),'warn');return;} h.pop(); saveEnergyHistoryMain(h); setStatus(tr('statusHistDelMain'),'ok');}
  else{const h=loadEnergyHistory(); if(!h.length){setStatus(tr('statusHistEmptyNorm'),'warn');return;} h.pop(); saveEnergyHistory(h); setStatus(tr('statusHistDelNorm'),'ok');}
  drawEnergyHistory();
}
if(btnResetLast) btnResetLast.addEventListener('click',removeLastHistoryEntry);
let _resetHoldTimer=null, _resetRepeatTimer=null; const _initialDelayMs=600, _repeatEveryMs=250;
function _startResetAutoRepeat(){ if(_resetHoldTimer||_resetRepeatTimer) return; _resetHoldTimer=setTimeout(()=>{ removeLastHistoryEntry(); _resetRepeatTimer=setInterval(removeLastHistoryEntry,_repeatEveryMs); }, _initialDelayMs); }
function _stopResetAutoRepeat(){ if(_resetHoldTimer){clearTimeout(_resetHoldTimer);_resetHoldTimer=null;} if(_resetRepeatTimer){clearInterval(_resetRepeatTimer);_resetRepeatTimer=null;} }
if(btnResetLast){ btnResetLast.addEventListener('mousedown',e=>{ if(e.button===0) _startResetAutoRepeat();}); window.addEventListener('mouseup',_stopResetAutoRepeat); btnResetLast.addEventListener('mouseleave',_stopResetAutoRepeat); btnResetLast.addEventListener('touchstart',e=>{e.preventDefault();_startResetAutoRepeat();},{passive:false}); window.addEventListener('touchend',_stopResetAutoRepeat); window.addEventListener('touchcancel',_stopResetAutoRepeat); btnResetLast.addEventListener('contextmenu',e=>e.preventDefault());}

/* Graph */
function mapValToY(val,minV,maxV){const h=canvas.height,p=(val-minV)/(maxV-minV||1);return(h-1)-p*(h-1);}
function drawGraph(intensityValues,secondSeries,isNorm=false){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  try{
    const totalTime = Math.max((typeof lastT!=='undefined' && typeof t0!=='undefined') ? (lastT - t0) : 0, 0);
    if (totalTime > 0.001){
      const secs = Math.floor(totalTime);
      const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--grid') || '#e9e9e9';
      ctx.strokeStyle = gridColor; ctx.lineWidth = 1; ctx.textAlign = 'center'; ctx.fillStyle = '#555'; ctx.font = '11px Arial';
      for (let s=0; s<=secs; s++){
        const x = (s / totalTime) * canvas.width;
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        if (s % 5 === 0){ ctx.save(); ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); ctx.restore(); }
        ctx.fillText(String(s), x, canvas.height - 6);
      }
      ctx.textAlign = 'left';
    }
  }catch(e){}
  let maxI=Math.max(...intensityValues)||1, maxS=Math.max(...secondSeries)||1;
  const maxIfs=maxI*1.05, maxSfs=maxS*1.1;
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid');
  for(let i=0;i<=5;i++){const y=mapValToY(maxIfs*i/5,0,maxIfs);ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--axes');ctx.beginPath();ctx.moveTo(0,canvas.height-1);ctx.lineTo(canvas.width,canvas.height-1);ctx.moveTo(0,0);ctx.lineTo(0,canvas.height);ctx.stroke();
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text');ctx.font='12px Arial';ctx.textAlign='left';
  for(let i=0;i<=5;i++){const v=maxIfs*i/5,y=mapValToY(v,0,maxIfs);ctx.fillText(v.toExponential(2),5,y-3);}
  ctx.save();ctx.rotate(-Math.PI/2);ctx.fillText(tr('yLeft'),-canvas.height+10,14);ctx.restore();
  ctx.textAlign='right';
  for(let i=0;i<=5;i++){const v=maxSfs*i/5,y=mapValToY(v,0,maxSfs);ctx.fillText(isNorm?v.toFixed(2):v.toExponential(2),canvas.width-5,y-3);}
  ctx.save();ctx.rotate(Math.PI/2);ctx.fillText(isNorm?tr('yRightNorm'):tr('yRightRaw'),canvas.height/2-60,canvas.width-10);ctx.restore();
  ctx.beginPath(); for(let i=0;i<intensityValues.length;i++){const x=(i/Math.max(intensityValues.length-1,1))*canvas.width;const y=mapValToY(intensityValues[i],0,maxIfs);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);} ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--blue');ctx.lineWidth=2;ctx.stroke();
  ctx.beginPath(); for(let i=0;i<secondSeries.length;i++){const x=(i/Math.max(secondSeries.length-1,1))*canvas.width;const y=mapValToY(secondSeries[i],0,maxSfs);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);} ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--green');ctx.lineWidth=2;ctx.stroke();
  if (secondSeries.length>1){
    const last = secondSeries[secondSeries.length-1];
    const y = mapValToY(last, 0, maxSfs);
    ctx.beginPath(); ctx.setLineDash([5,3]); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--green-dark'); ctx.lineWidth=1; ctx.stroke(); ctx.setLineDash([]);
  }
  if (signalStartTime !== null) {
    const totalTime = lastT - t0;
    if (totalTime > 0) {
      const xStart = (signalStartTime / totalTime) * canvas.width;
      ctx.beginPath(); ctx.setLineDash([5, 3]); ctx.moveTo(xStart, 0); ctx.lineTo(xStart, canvas.height);
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--signal-start') || '#ff6b00'; ctx.lineWidth = 3; ctx.shadowBlur = 8; ctx.shadowColor = 'rgba(255,107,0,0.7)'; ctx.stroke(); ctx.setLineDash([]); ctx.shadowBlur = 0;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--signal-start') || '#ff6b00'; ctx.font = 'bold 12px Arial'; ctx.fillText('–ù–∞—á–∞–ª–æ', xStart + 5, 15);
    }
  }
  try {
    const mode = getMode();
    const refNow = getNormalizationReference();
    if (mode==='main' && !refNow && cutTimeAbs!==null) {
      const totalTime = lastT - t0;
      if (totalTime > 0) {
        const xCut = (cutTimeAbs / totalTime) * canvas.width;
        ctx.beginPath(); ctx.setLineDash([4, 4]); ctx.moveTo(xCut, 0); ctx.lineTo(xCut, canvas.height);
        ctx.strokeStyle = '#444'; ctx.lineWidth = 2; ctx.stroke(); ctx.setLineDash([]);
        ctx.fillStyle = '#333'; ctx.font = 'bold 12px Arial'; ctx.fillText('+1—Å', xCut + 5, 45);
      }
    }
  } catch(e) {}
  if (signalEndTime !== null) {
    const totalTime = lastT - t0;
    if (totalTime > 0) {
      const xEnd = (signalEndTime / totalTime) * canvas.width;
      ctx.beginPath(); ctx.setLineDash([5, 3]); ctx.moveTo(xEnd, 0); ctx.lineTo(xEnd, canvas.height);
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--signal-end') || '#ff0066'; ctx.lineWidth = 3; ctx.shadowBlur = 8; ctx.shadowColor = 'rgba(255,0,102,0.7)'; ctx.stroke(); ctx.setLineDash([]); ctx.shadowBlur = 0;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--signal-end') || '#ff0066'; ctx.font = 'bold 12px Arial'; ctx.fillText('–ö–æ–Ω–µ—Ü', xEnd + 5, 30);
    }
  }
  if (currentThreshold > 0) {
    const yThreshold = mapValToY(currentThreshold, 0, maxIfs);
    ctx.beginPath(); ctx.setLineDash([3, 3]); ctx.moveTo(0, yThreshold); ctx.lineTo(canvas.width, yThreshold);
    ctx.strokeStyle = '#888'; ctx.lineWidth = 1; ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle = '#666'; ctx.font = '10px Arial'; ctx.fillText(`–ü–æ—Ä–æ–≥: ${currentThreshold.toExponential(2)}`, 10, yThreshold - 5);
  }
}

/* Mic */
async function requestMicrophoneAccess(){
  try{
    micStream=await navigator.mediaDevices.getUserMedia({audio:true});
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    analyser=audioCtx.createAnalyser(); analyser.fftSize=2048; source=audioCtx.createMediaStreamSource(micStream); source.connect(analyser);
    setStatus(tr('statusMicOk'),'ok');
  }catch(e){ setStatus(tr('statusMicErr')+e.message,'error'); }
}

/* Recording */
let intensityValues=[], integralValues=[];
function rms(b){let a=0;for(let v of b)a+=v*v;return Math.sqrt(a/(b.length||1));}
function tick(){
  if(!recording) return;
  const buffer=new Float32Array(analyser.fftSize); analyser.getFloatTimeDomainData(buffer);
  const r=rms(buffer), intensity=r*r;
  const t=audioCtx.currentTime, dt=Math.max(0,t-lastT); lastT=t;
  const relTime = t - t0; sampleTimes.push(relTime);
  const last=(integralValues.length?integralValues[integralValues.length-1]:0);
  const next=last+intensity*dt;
  intensityValues.push(intensity); integralValues.push(next);
  if (checkAutoStop(t)) { return; }
  const signalEvent = detectSignal(intensity, next, t);
  if (signalEvent === 'start') {
    cutTimeAbs = signalStartTime + 1.0; cutPointPercent = null;
    setStatus('üîä –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–∞—á–∞–ª–æ —Å–∏–≥–Ω–∞–ª–∞', 'ok');
  } else if (signalEvent === 'end') {
    setStatus('üîá –û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–æ–Ω–µ—Ü —Å–∏–≥–Ω–∞–ª–∞', 'ok');
  }
  updateSignalInfo();
  const mode=getMode();
  if(mode==='normalization'){
    drawGraph(intensityValues, integralValues, false);
  }else{
    const ref=getNormalizationReference();
    if(ref){
      const norm=integralValues.map(v=>v/ref);
      drawGraph(intensityValues, norm, true);
    }else{
      const lastNow = integralValues.length ? integralValues[integralValues.length-1] : 1;
      const norm=integralValues.map(v=>v/(lastNow||1));
      if (cutTimeAbs !== null && sampleTimes.length>0) {
        let idx = sampleTimes.findIndex(tt => tt >= cutTimeAbs);
        if (idx === -1) idx = sampleTimes.length - 1;
        const val = norm[Math.max(0, idx)] || 0;
        cutPointPercent = Math.max(0, Math.min(100, val*100));
      }
      drawGraph(intensityValues, norm, true);
    }
  }
  rafId=requestAnimationFrame(tick);
}

function stopRecordingAndFinalize(){
  recording=false; if(rafId) { cancelAnimationFrame(rafId); rafId = null; }
  if (isSignalActive && signalStartTime !== null && signalEndTime === null) {
    signalEndTime = lastT - t0; updateSignalInfo();
  }
  const mode=getMode();
  if(mode==='normalization'){
    const last=integralValues.length?integralValues[integralValues.length-1]:0;
    addEnergyHistoryEntry(last);
    setStatus(tr('statusNormOn'),'warn');
  }else{
    const ref=getNormalizationReference();
    const last=integralValues.length?integralValues[integralValues.length-1]:0;
    const norm=ref ? (last/ref) : 1;
    if (!ref) {
      const lastNow = last||1;
      const normSeries = integralValues.map(v=>v/(lastNow||1));
      const ds = _downsampleSeries(normSeries, 200);
      let cutPct = null;
      if (cutTimeAbs !== null && sampleTimes.length>0) {
        let idx = sampleTimes.findIndex(tt => tt >= cutTimeAbs);
        if (idx === -1) idx = sampleTimes.length-1;
        const val = normSeries[Math.max(0, idx)] || 0;
        cutPct = Math.max(0, Math.min(100, val*100));
      }
      const d = new Date(); d.setSeconds(0,0);
      const h = loadEnergyHistoryMain();
      h.push({ts:d.toISOString(), norm:Number(norm)||0, cut:cutPct, series:ds});
      saveEnergyHistoryMain(h);
    } else {
      addEnergyHistoryEntryMain(norm);
    }
    setStatus(tr('statusMainDone'),'ok');
  }
  drawEnergyHistory();
  hideLowIntensityWarning();
}

/* Reset */
function resetRecording(){
  recording=false; t0=0; lastT=0; intensityValues=[]; integralValues=[]; sampleTimes=[]; cutTimeAbs=null; cutPointPercent=null;
  signalStartTime = null; signalEndTime = null; isSignalActive = false; maxIntensity = 0; lastIntegralValue = 0; stableCount = 0; currentThreshold = 0;
  if(rafId) { cancelAnimationFrame(rafId); rafId = null; }
  updateSignalInfo(); setThresholdInfo('Current threshold: ‚Äî');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  setStatus(tr('statusReset'),'ok'); hideLowIntensityWarning();
}

/* Init */
function initI18n(){
  const sel=document.getElementById('langSelect'); if(!sel) return;
  const saved=localStorage.getItem(LANG_KEY)||'ru';
  sel.value=saved; applyTranslations(saved);
  sel.addEventListener('change',e=>{ applyTranslations(e.target.value); try{ drawEnergyHistory(); }catch(_){}});
}
function init(){
  initI18n(); applyMode();
  const slider = document.getElementById('thrSlider');
  const out = document.getElementById('thrValue');
  const s2 = document.getElementById('stabSlider');
  const o2 = document.getElementById('stabValue');
  if(btnRequestMic) btnRequestMic.addEventListener('click',requestMicrophoneAccess);
  if(btnStart) btnStart.addEventListener('click',()=>{
    if(!analyser){ setStatus('–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω.','error'); return; }
    resetRecording();
    recording=true; t0=audioCtx.currentTime; lastT=t0;
    setStatus(tr('statusRec'),'ok');
    tick();
  });
  if(btnStop) btnStop.addEventListener('click',stopRecordingAndFinalize);
  if(btnReset) btnReset.addEventListener('click',resetRecording);
  if(btnStartNorm) btnStartNorm.addEventListener('click',()=>setMode('normalization'));
  if(btnFinishNorm) btnFinishNorm.addEventListener('click',()=>setMode('main'));
  if(btnTech) btnTech.addEventListener('click', openTech);
  if(btnCloseTech) btnCloseTech.addEventListener('click', ()=>{ closeTech(); });
  if(techModal){
    techModal.addEventListener('click', closeTech);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeTech(); });
  }
  // Initialize threshold slider (technical modal)
  try{
    if (slider && out){
      const pct = getThresholdPct();
      slider.value = String(pct);
      out.textContent = pct.toFixed(1) + '%';
      slider.addEventListener('input', (e)=>{
        const v = parseFloat(e.target.value);
        setThresholdPct(v);
        out.textContent = v.toFixed(1) + '%';
        const rel = Math.max(maxIntensity * getRelativeThresholdFraction(), ABSOLUTE_FLOOR);
        setThresholdInfo(`Current threshold: ${rel.toExponential(2)} (${getThresholdPct().toFixed(1)}% of max ${maxIntensity>0?maxIntensity.toExponential(2):'‚Äî'})`);
      });
    }
  }catch(e){}
  // Initialize stability slider (technical modal)
  try{
    if (s2 && o2){
      const pct2 = getStabilityPct();
      s2.value = String(pct2);
      o2.textContent = pct2.toFixed(2) + '%';
      s2.addEventListener('input', (e)=>{
        const v = parseFloat(e.target.value);
        setStabilityPct(v);
        o2.textContent = v.toFixed(2) + '%';
      });
    }
  }catch(e){} 
  drawEnergyHistory();
  // Ensure modal is English at startup:
  try{
    const tt=document.getElementById('techTitle'); if(tt) tt.textContent='Technical settings';
    const bc=document.getElementById('btnCloseTech'); if(bc) bc.textContent='Close';
    const ti=document.getElementById('thresholdInfo'); if(ti && (ti.textContent.trim()===''||ti.textContent.includes('‚Äî'))) ti.textContent='Current threshold: ‚Äî';
  }catch(e){}
}
window.addEventListener('load',init);
</script>
</body>
</html>
