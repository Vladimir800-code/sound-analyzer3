<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ‚Äî –ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ / –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --grid:#e9e9e9;
    --axes:#222;
    --text:#111;
    --blue:#2f6fed;
    --green:#1aab55;
    --green-dark:#0f6e35;
    --warn:#b15d00;
    --ok:#0a7a2e;
    --error:#b00020;
  }
  body{font-family:Arial, sans-serif; margin:0; background:#fff; color:#111;}
  header{padding:10px 12px; border-bottom:1px solid #ddd; background:#fafafa}
  h1{font-size:18px; margin:4px 0;}
  main{padding:8px 0 18px;}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin:8px 12px;}
  .button{padding:8px 14px; border-radius:8px; border:1px solid #ccc; cursor:pointer; background:#f5f5f5}
  .button.primary{background:#2f6fed; border-color:#2f6fed; color:#fff}
  .button.alt{background:#fbe9e7; border-color:#f5ccbd; color:#5d2a00}
  .button:disabled{opacity:0.5; cursor:not-allowed}
  #modeBadge{margin-left:auto; font-size:12px; padding:4px 8px; border-radius:999px; background:#eef; color:#223;}
  body[data-mode="normalization"] #modeBadge{background:#fff6d6; color:#6b4e00;}
  body[data-mode="main"] #modeBadge{background:#e6ffe7; color:#0a5c10;}
  .card{border:1px solid #ddd; border-radius:10px; padding:10px 12px; background:#fff; margin:8px 12px;}
  .status{margin:8px 12px; font-size:14px;}
  .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.error{color:var(--error)}
  canvas{border:1px solid #ddd; border-radius:6px; margin:8px 12px;}
  .hint{font-size:12px; color:#555; margin:0 12px 12px;}
</style>
</head>
<body>
<header>
  <h1>–ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ ‚Äî –≠—Ç–∞–ø 1: ¬´–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ¬ª ‚Üí –≠—Ç–∞–ø 2: ¬´–û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑¬ª</h1>
</header>

<main>
  <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
  <div class="toolbar" id="normToolbar">
    <button id="btnStartNorm" class="button">–ù–∞—á–∞—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <button id="btnFinishNorm" class="button primary">–ó–∞–∫–æ–Ω—á–∏—Ç—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <span id="modeBadge">–†–µ–∂–∏–º: ‚Äî</span>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—å—é -->
  <div class="toolbar">
    <button id="btnRequestMic" class="button alt">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</button>
    <button id="btnStart" class="button">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
    <button id="btnStop" class="button">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    <button id="btnReset" class="button">–°–±—Ä–æ—Å</button>
  </div>

  <div class="status" id="status">–ì–æ—Ç–æ–≤.</div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ -->
  <canvas id="mainGraph" width="980" height="320"></canvas>

  <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ -->
  <section id="historySection" class="card">
    <h3 style="margin:0 0 6px 0;">–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞</h3>
    <canvas id="historyGraph" width="980" height="240"></canvas>
    <div class="hint">–í —Ä–µ–∂–∏–º–µ –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã —ç–Ω–µ—Ä–≥–∏–∏ (–í—Ç¬∑—Å/–º¬≤). –í –æ—Å–Ω–æ–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äî –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Å–∏–º–ø—Ç–æ—Ç—ã (–±–µ–∑—Ä–∞–∑–º–µ—Ä–Ω—ã–µ, –º–æ–≥—É—Ç –±—ã—Ç—å &gt;1 –∏–ª–∏ &lt;1).</div>
    <div class="toolbar" style="justify-content:flex-end; margin-top:4px;">
      <button id="btnResetLast" class="button">–°–±—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ</button>
    </div>
  </section>
</main>

<script>
// ======== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ========
let audioCtx=null, micStream=null, analyser=null, source=null, rafId=null;
let recording=false, t0=0, lastT=0;
const MODE_KEY='analysisModeV1';
const ENERGY_HISTORY_KEY='energyHistoryV1';
const ENERGY_HISTORY_MAIN_KEY='energyHistoryMainV1';
const modeBadge=document.getElementById('modeBadge');
const statusEl=document.getElementById('status');
const canvas=document.getElementById('mainGraph'), ctx=canvas.getContext('2d');
const historyCanvas=document.getElementById('historyGraph'), hctx=historyCanvas.getContext('2d');
const btnRequestMic=document.getElementById('btnRequestMic');
const btnStart=document.getElementById('btnStart');
const btnStop=document.getElementById('btnStop');
const btnReset=document.getElementById('btnReset');
const btnStartNorm=document.getElementById('btnStartNorm');
const btnFinishNorm=document.getElementById('btnFinishNorm');
const btnResetLast=document.getElementById('btnResetLast');

// ======== –£—Ç–∏–ª–∏—Ç—ã —Å—Ç–∞—Ç—É—Å–∞ ========
function setStatus(msg, level='ok'){ statusEl.className='status '+(level||'ok'); statusEl.textContent=msg; }

// ======== –†–µ–∂–∏–º—ã ========
function getMode(){const v=localStorage.getItem(MODE_KEY); return (v==='main'||v==='normalization')?v:'normalization';}
function setMode(v){localStorage.setItem(MODE_KEY,v); applyMode();}
function applyMode(){const mode=getMode(); document.body.setAttribute('data-mode',mode); modeBadge.textContent='–†–µ–∂–∏–º: '+(mode==='normalization'?'–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ':'–û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑'); drawEnergyHistory();}

// ======== –ò—Å—Ç–æ—Ä–∏–∏ ========
function loadEnergyHistory(){try{const r=localStorage.getItem(ENERGY_HISTORY_KEY); return r?JSON.parse(r):[]}catch{return[]}}
function saveEnergyHistory(a){try{localStorage.setItem(ENERGY_HISTORY_KEY,JSON.stringify(a))}catch{}}
function addEnergyHistoryEntry(e){const d=new Date(); d.setSeconds(0,0); const h=loadEnergyHistory(); h.push({ts:d.toISOString(),energy:Number(e)||0}); saveEnergyHistory(h);}
function loadEnergyHistoryMain(){try{const r=localStorage.getItem(ENERGY_HISTORY_MAIN_KEY); return r?JSON.parse(r):[]}catch{return[]}}
function saveEnergyHistoryMain(a){try{localStorage.setItem(ENERGY_HISTORY_MAIN_KEY,JSON.stringify(a))}catch{}}
function addEnergyHistoryEntryMain(n){const d=new Date(); d.setSeconds(0,0); const h=loadEnergyHistoryMain(); h.push({ts:d.toISOString(),norm:Number(n)||0}); saveEnergyHistoryMain(h);}
function getNormalizationReference(){const h=loadEnergyHistory(); if(!h.length)return null; let m=-Infinity; for(const x of h){const v=Number(x.energy)||0; if(v>m)m=v;} return (isFinite(m)&&m>0)?m:null;}

// ======== –ì—Ä–∞—Ñ–∏–∫ –∏—Å—Ç–æ—Ä–∏–∏ ========
function drawEnergyHistory(){
  const mode=getMode(), isMain=(mode==='main');
  const data=isMain?loadEnergyHistoryMain():loadEnergyHistory();
  hctx.clearRect(0,0,historyCanvas.width,historyCanvas.height);
  if(!data.length){hctx.fillStyle='#555'; hctx.font='14px Arial'; hctx.fillText(isMain?'–ò—Å—Ç–æ—Ä–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—É—Å—Ç–∞.':'–ò—Å—Ç–æ—Ä–∏—è –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–∞.',20,30);return;}
  const vals=data.map(d=>isMain?(+d.norm||0):(+d.energy||0)); const maxV=Math.max(...vals)||1;
  const leftPad=50,bottomPad=28,rightPad=20,topPad=12; const W=historyCanvas.width-leftPad-rightPad,H=historyCanvas.height-topPad-bottomPad;
  hctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid'); hctx.lineWidth=1;
  for(let i=0;i<=4;i++){const y=topPad+H-(H*i/4);hctx.beginPath();hctx.moveTo(leftPad,y);hctx.lineTo(leftPad+W,y);hctx.stroke();hctx.fillStyle='#555';hctx.font='11px Arial';const v=maxV*i/4;const lab=isMain?v.toFixed(2):v.toExponential(2);hctx.fillText(lab,6,y-2);}
  hctx.strokeStyle='#000';hctx.beginPath();hctx.moveTo(leftPad,topPad);hctx.lineTo(leftPad,topPad+H);hctx.lineTo(leftPad+W,topPad+H);hctx.stroke();
  hctx.fillStyle='#000';hctx.font='12px Arial';hctx.fillText('‚Ññ —Å–µ–∞–Ω—Å–∞ / –≤—Ä–µ–º—è',leftPad+W/2-60,topPad+H+22);hctx.save();hctx.rotate(-Math.PI/2);hctx.fillText(isMain?'–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Å–∏–º–ø—Ç–æ—Ç–∞ (–æ—Ç–Ω.)':'–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è (–í—Ç¬∑—Å/–º¬≤)',-topPad-H/2-80,15);hctx.restore();
  hctx.beginPath(); const N=data.length; for(let i=0;i<N;i++){const x=leftPad+(W*(i/Math.max(1,N-1))); const y=topPad+H-(H*(vals[i]/maxV)); if(i===0)hctx.moveTo(x,y); else hctx.lineTo(x,y);} hctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--green'); hctx.lineWidth=2; hctx.stroke();
  hctx.fillStyle='#111';hctx.font='10px Arial';const step=Math.ceil(N/8); for(let i=0;i<N;i++){const x=leftPad+(W*(i/Math.max(1,N-1))); const y=topPad+H-(H*(vals[i]/maxV)); hctx.beginPath();hctx.arc(x,y,2.5,0,Math.PI*2);hctx.fill(); if(i%step===0||i===N-1){const d=new Date(data[i].ts); const lab=d.toLocaleString(undefined,{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});hctx.fillText(lab,x-32,topPad+H+14);}}
}

// ======== –°–±—Ä–æ—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ ========
function removeLastHistoryEntry(){
  const mode=getMode();
  if(mode==='main'){const h=loadEnergyHistoryMain(); if(!h.length){setStatus('–ò—Å—Ç–æ—Ä–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—É—Å—Ç–∞.','warn');return;} h.pop(); saveEnergyHistoryMain(h); setStatus('–£–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.','ok');}
  else{const h=loadEnergyHistory(); if(!h.length){setStatus('–ò—Å—Ç–æ—Ä–∏—è –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—É—Å—Ç–∞.','warn');return;} h.pop(); saveEnergyHistory(h); setStatus('–£–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è.','ok');}
  drawEnergyHistory();
}
if(btnResetLast) btnResetLast.addEventListener('click',removeLastHistoryEntry);

// ======== –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ ========
function mapValToY(val,minV,maxV){const h=canvas.height,p=(val-minV)/(maxV-minV||1);return(h-1)-p*(h-1);}
function drawGraph(intensityValues,secondSeries,isNorm=false){ctx.clearRect(0,0,canvas.width,canvas.height);
  let maxI=Math.max(...intensityValues)||1, maxS=Math.max(...secondSeries)||1;
  const maxIfs=maxI*1.05,maxSfs=maxS*1.1;
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid'); for(let i=0;i<=5;i++){const y=mapValToY(maxIfs*i/5,0,maxIfs);ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--axes');ctx.beginPath();ctx.moveTo(0,canvas.height-1);ctx.lineTo(canvas.width,canvas.height-1);ctx.moveTo(0,0);ctx.lineTo(0,canvas.height);ctx.stroke();
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text');ctx.font='12px Arial';ctx.textAlign='left';for(let i=0;i<=5;i++){const v=maxIfs*i/5,y=mapValToY(v,0,maxIfs);ctx.fillText(v.toExponential(2),5,y-3);}ctx.save();ctx.rotate(-Math.PI/2);ctx.fillText('–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (—É—Å–ª. –µ–¥.)',-canvas.height+10,14);ctx.restore();
  ctx.textAlign='right';for(let i=0;i<=5;i++){const v=maxSfs*i/5,y=mapValToY(v,0,maxSfs);ctx.fillText(isNorm?v.toFixed(2):v.toExponential(2),canvas.width-5,y-3);}ctx.save();ctx.rotate(Math.PI/2);ctx.fillText(isNorm?'–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è (–æ—Ç–Ω.)':'–≠–Ω–µ—Ä–≥–∏—è (–í—Ç¬∑—Å/–º¬≤ ‚Äî —É—Å–ª.)',canvas.height/2-60,canvas.width-10);ctx.restore();
  ctx.beginPath();for(let i=0;i<intensityValues.length;i++){const x=(i/Math.max(intensityValues.length-1,1))*canvas.width;const y=mapValToY(intensityValues[i],0,maxIfs);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--blue');ctx.lineWidth=2;ctx.stroke();
  ctx.beginPath();for(let i=0;i<secondSeries.length;i++){const x=(i/Math.max(secondSeries.length-1,1))*canvas.width;const y=mapValToY(secondSeries[i],0,maxSfs);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--green');ctx.lineWidth=2;ctx.stroke();}

// ======== –ú–∏–∫—Ä–æ—Ñ–æ–Ω ========
async function requestMicrophoneAccess(){try{micStream=await navigator.mediaDevices.getUserMedia({audio:true}); if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); analyser=audioCtx.createAnalyser();analyser.fftSize=2048;source=audioCtx.createMediaStreamSource(micStream);source.connect(analyser);setStatus('‚úÖ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω.','ok');}catch(e){setStatus('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: '+e.message,'error');}}

// ======== –ó–∞–ø–∏—Å—å ========
let intensityValues=[], integralValues=[];
function rms(b){let a=0;for(let v of b)a+=v*v;return Math.sqrt(a/(b.length||1));}
function tick(){if(!recording)return;const buf=new Float32Array(analyser.fftSize);analyser.getFloatTimeDomainData(buf);const r=rms(buf),int=r*r;const t=audioCtx.currentTime,dt=Math.max(0,t-lastT);lastT=t;const last=integralValues.length?integralValues[integralValues.length-1]:0;const next=last+int*dt;intensityValues.push(int);integralValues.push(next);
  const mode=getMode();if(mode==='normalization'){drawGraph(intensityValues,integralValues,false);}else{const ref=getNormalizationReference();if(ref){const norm=integralValues.map(v=>v/ref);drawGraph(intensityValues,norm,true);}else{drawGraph(intensityValues,integralValues,false);}}rafId=requestAnimationFrame(tick);}
function stopRecordingAndFinalize(){recording=false;if(rafId)cancelAnimationFrame(rafId);const last=integralValues.length?integralValues[integralValues.length-1]:0;const mode=getMode();if(mode==='normalization'){addEnergyHistoryEntry(last);}else{const ref=getNormalizationReference();if(ref){addEnergyHistoryEntryMain(last/ref);}}drawEnergyHistory();setStatus('‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω.','ok');}

// ======== –ö–Ω–æ–ø–∫–∏ ========
btnRequestMic.addEventListener('click',()=>{requestMicrophoneAccess();});
btnStart.addEventListener('click',async()=>{if(!micStream)await requestMicrophoneAccess();if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')await audioCtx.resume();intensityValues=[];integralValues=[];t0=audioCtx.currentTime;lastT=t0;recording=true;setStatus('üü¢ –ó–∞–ø–∏—Å—å –∑–∞–ø—É—â–µ–Ω–∞.','ok');tick();});
btnStop.addEventListener('click',()=>{stopRecordingAndFinalize();});
btnReset.addEventListener('click',()=>{intensityValues=[];integralValues=[];ctx.clearRect(0,0,canvas.width,canvas.height);setStatus('–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö.');});
btnStartNorm.addEventListener('click',()=>{setMode('normalization');setStatus('üü° –†–µ–∂–∏–º –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è.','ok');});
btnFinishNorm.addEventListener('click',()=>{setMode('main');const ref=getNormalizationReference();if(!ref)setStatus('‚ö†Ô∏è –ù–µ—Ç —ç—Ç–∞–ª–æ–Ω–∞ –Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è.','warn');else setStatus('üü¢ –ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.','ok');});

// ======== Init ========
window.addEventListener('load',()=>{applyMode();drawEnergyHistory();setStatus('–ì–æ—Ç–æ–≤.','ok');});
</script>
</body>
</html>
